# AUTOGENERATED! DO NOT EDIT! File to edit: ../01_toolloop.ipynb.

# %% auto 0
__all__ = ['CodeChat']

# %% ../01_toolloop.ipynb 2
from .core import *
from fastcore.utils import *

from anthropic.types import TextBlock, Message
from anthropic.types.beta.tools import ToolsBetaMessage, tool_use_block

# %% ../01_toolloop.ipynb 16
@patch
def toolloop(self:Chat,
             pr, # Prompt to pass to Claude
             max_steps=10, # Maximum number of tool requests to loop through
             temp=0, # Temperature
             maxtok=4096, # Maximum tokens
             stop:Optional[list[str]]=None, # Stop sequences
             trace_func:Optional[callable]=None, # Function to trace tool use steps (e.g `print`)
             cont_func:Optional[callable]=noop, # Function that stops loop if returns False
             **kw):
    "Add prompt `pr` to dialog and get a response from Claude, automatically following up with `tool_use` messages"
    r = self(pr, temp=temp, maxtok=maxtok, stop=stop, **kw)
    for i in range(max_steps):
        if r.stop_reason!='tool_use': break
        if trace_func: trace_func(r)
        r = self(r, temp=temp, maxtok=maxtok, stop=stop, **kw)
        if not (cont_func or noop)(self.h[-2]['content']): break
    if trace_func: trace_func(r)
    return r

# %% ../01_toolloop.ipynb 24
from execnb.shell import CaptureShell
from fastcore.meta import delegates
import traceback

# %% ../01_toolloop.ipynb 27
@delegates()
class CodeChat(Chat):
    def __init__(self, model: Optional[str] = None, ask:bool=True, **kwargs):
        super().__init__(model=model, **kwargs)
        self.ask = ask
        self.tools.append(self.run_cell)
        self.shell = CaptureShell()
        self.shell.run('import '+imps)

    def run_cell(
        self,
        code:str,   # Code to execute in persistent IPython session
    ): # Result of expression on last line (if exists); '#DECLINED#' if user declines request to exectute
        "Asks user for permission, and if provided, executes python `code` using persistent IPython session."
        confirm = f'Press Enter to execute, or enter "n" to skip?\n```\n{code}\n```\n'
        if self.ask and input(confirm): return '#DECLINED#'
        try: return self.shell.run(code)
        except Exception as e: return traceback.format_exc()
