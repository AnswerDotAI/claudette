<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Claudette’s source – claudette</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-3079788b0fb9d9587af933d59c4f2ea1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Claudette’s source – claudette">
<meta property="og:description" content="Claudette is Claude’s friend">
<meta property="og:image" content="https://claudette.answer.ai/00_core_files/figure-html/cell-175-output-1.jpeg">
<meta property="og:site_name" content="claudette">
<meta name="twitter:title" content="Claudette’s source – claudette">
<meta name="twitter:description" content="Claudette is Claude’s friend">
<meta name="twitter:image" content="https://claudette.answer.ai/00_core_files/figure-html/cell-175-output-1.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">claudette</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">Claudette’s source</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">claudette</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Claudette’s source</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./toolloop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tool loop</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./async.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The async version</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text_editor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Editor</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#can_use_extended_thinking" id="toc-can_use_extended_thinking" class="nav-link" data-scroll-target="#can_use_extended_thinking">can_use_extended_thinking</a></li>
  <li><a href="#can_set_temperature" id="toc-can_set_temperature" class="nav-link" data-scroll-target="#can_set_temperature">can_set_temperature</a></li>
  <li><a href="#can_set_system_prompt" id="toc-can_set_system_prompt" class="nav-link" data-scroll-target="#can_set_system_prompt">can_set_system_prompt</a></li>
  <li><a href="#can_stream" id="toc-can_stream" class="nav-link" data-scroll-target="#can_stream">can_stream</a></li>
  </ul></li>
  <li><a href="#antropic-sdk" id="toc-antropic-sdk" class="nav-link" data-scroll-target="#antropic-sdk">Antropic SDK</a>
  <ul class="collapse">
  <li><a href="#formatting-output" id="toc-formatting-output" class="nav-link" data-scroll-target="#formatting-output">Formatting output</a></li>
  <li><a href="#find_block" id="toc-find_block" class="nav-link" data-scroll-target="#find_block">find_block</a></li>
  <li><a href="#server_tool_usage" id="toc-server_tool_usage" class="nav-link" data-scroll-target="#server_tool_usage">server_tool_usage</a></li>
  <li><a href="#usage" id="toc-usage" class="nav-link" data-scroll-target="#usage">usage</a></li>
  <li><a href="#usage.total" id="toc-usage.total" class="nav-link" data-scroll-target="#usage.total">Usage.total</a></li>
  <li><a href="#usage.__repr__" id="toc-usage.__repr__" class="nav-link" data-scroll-target="#usage.__repr__">Usage.__repr__</a></li>
  <li><a href="#servertoolusage.__add__" id="toc-servertoolusage.__add__" class="nav-link" data-scroll-target="#servertoolusage.__add__">ServerToolUsage.__add__</a></li>
  <li><a href="#usage.__add__" id="toc-usage.__add__" class="nav-link" data-scroll-target="#usage.__add__">Usage.__add__</a></li>
  <li><a href="#creating-messages" id="toc-creating-messages" class="nav-link" data-scroll-target="#creating-messages">Creating messages</a></li>
  </ul></li>
  <li><a href="#client" id="toc-client" class="nav-link" data-scroll-target="#client">Client</a>
  <ul class="collapse">
  <li><a href="#client-1" id="toc-client-1" class="nav-link" data-scroll-target="#client-1">Client</a></li>
  <li><a href="#get_types" id="toc-get_types" class="nav-link" data-scroll-target="#get_types">get_types</a></li>
  <li><a href="#mk_tool_choice" id="toc-mk_tool_choice" class="nav-link" data-scroll-target="#mk_tool_choice">mk_tool_choice</a></li>
  <li><a href="#client.__call__" id="toc-client.__call__" class="nav-link" data-scroll-target="#client.__call__">Client.__call__</a></li>
  <li><a href="#get_pricing" id="toc-get_pricing" class="nav-link" data-scroll-target="#get_pricing">get_pricing</a></li>
  <li><a href="#usage.cost" id="toc-usage.cost" class="nav-link" data-scroll-target="#usage.cost">Usage.cost</a></li>
  <li><a href="#client.cost" id="toc-client.cost" class="nav-link" data-scroll-target="#client.cost">Client.cost</a></li>
  <li><a href="#get_costs" id="toc-get_costs" class="nav-link" data-scroll-target="#get_costs">get_costs</a></li>
  </ul></li>
  <li><a href="#tool-use" id="toc-tool-use" class="nav-link" data-scroll-target="#tool-use">Tool use</a>
  <ul class="collapse">
  <li><a href="#toolresult" id="toc-toolresult" class="nav-link" data-scroll-target="#toolresult">ToolResult</a></li>
  <li><a href="#mk_funcres" id="toc-mk_funcres" class="nav-link" data-scroll-target="#mk_funcres">mk_funcres</a></li>
  <li><a href="#limit-tool-access" id="toc-limit-tool-access" class="nav-link" data-scroll-target="#limit-tool-access">Limit tool access</a></li>
  <li><a href="#allowed_tools" id="toc-allowed_tools" class="nav-link" data-scroll-target="#allowed_tools">allowed_tools</a></li>
  <li><a href="#limit_ns" id="toc-limit_ns" class="nav-link" data-scroll-target="#limit_ns">limit_ns</a></li>
  <li><a href="#mk_toolres" id="toc-mk_toolres" class="nav-link" data-scroll-target="#mk_toolres">mk_toolres</a></li>
  <li><a href="#text-editing" id="toc-text-editing" class="nav-link" data-scroll-target="#text-editing">Text editing</a></li>
  </ul></li>
  <li><a href="#structured-data" id="toc-structured-data" class="nav-link" data-scroll-target="#structured-data">Structured data</a>
  <ul class="collapse">
  <li><a href="#client.structured" id="toc-client.structured" class="nav-link" data-scroll-target="#client.structured">Client.structured</a></li>
  </ul></li>
  <li><a href="#custom-types-with-tools-use" id="toc-custom-types-with-tools-use" class="nav-link" data-scroll-target="#custom-types-with-tools-use">Custom Types with Tools Use</a>
  <ul class="collapse">
  <li><a href="#tool" id="toc-tool" class="nav-link" data-scroll-target="#tool">tool</a></li>
  </ul></li>
  <li><a href="#chat" id="toc-chat" class="nav-link" data-scroll-target="#chat">Chat</a>
  <ul class="collapse">
  <li><a href="#chat-1" id="toc-chat-1" class="nav-link" data-scroll-target="#chat-1">Chat</a></li>
  <li><a href="#chat.cost" id="toc-chat.cost" class="nav-link" data-scroll-target="#chat.cost">Chat.cost</a></li>
  <li><a href="#chat.__call__" id="toc-chat.__call__" class="nav-link" data-scroll-target="#chat.__call__">Chat.__call__</a></li>
  <li><a href="#chat-tool-use" id="toc-chat-tool-use" class="nav-link" data-scroll-target="#chat-tool-use">Chat tool use</a></li>
  </ul></li>
  <li><a href="#images" id="toc-images" class="nav-link" data-scroll-target="#images">Images</a></li>
  <li><a href="#caching" id="toc-caching" class="nav-link" data-scroll-target="#caching">Caching</a></li>
  <li><a href="#extended-thinking" id="toc-extended-thinking" class="nav-link" data-scroll-target="#extended-thinking">Extended Thinking</a>
  <ul class="collapse">
  <li><a href="#think_md" id="toc-think_md" class="nav-link" data-scroll-target="#think_md">think_md</a></li>
  </ul></li>
  <li><a href="#server-tools-and-web-search" id="toc-server-tools-and-web-search" class="nav-link" data-scroll-target="#server-tools-and-web-search">Server Tools and Web Search</a>
  <ul class="collapse">
  <li><a href="#search_conf" id="toc-search_conf" class="nav-link" data-scroll-target="#search_conf">search_conf</a></li>
  <li><a href="#find_blocks" id="toc-find_blocks" class="nav-link" data-scroll-target="#find_blocks">find_blocks</a></li>
  <li><a href="#blks2cited_txt" id="toc-blks2cited_txt" class="nav-link" data-scroll-target="#blks2cited_txt">blks2cited_txt</a></li>
  <li><a href="#contents" id="toc-contents" class="nav-link" data-scroll-target="#contents">contents</a></li>
  </ul></li>
  <li><a href="#third-party-providers" id="toc-third-party-providers" class="nav-link" data-scroll-target="#third-party-providers">Third party providers</a>
  <ul class="collapse">
  <li><a href="#amazon-bedrock" id="toc-amazon-bedrock" class="nav-link" data-scroll-target="#amazon-bedrock">Amazon Bedrock</a></li>
  <li><a href="#google-vertex" id="toc-google-vertex" class="nav-link" data-scroll-target="#google-vertex">Google Vertex</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/AnswerDotAI/claudette/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Claudette’s source</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>This is the ‘literate’ source code for Claudette. You can view the fully rendered version of the notebook <a href="https://claudette.answer.ai/core.html">here</a>, or you can clone the git repo and run the <a href="https://github.com/AnswerDotAI/claudette/blob/main/00_core.ipynb">interactive notebook</a> in Jupyter. The notebook is converted the <a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py">Python module claudette/core.py</a> using <a href="https://nbdev.fast.ai/">nbdev</a>. The goal of this source code is to both create the Python module, and also to teach the reader <em>how</em> it is created, without assuming much existing knowledge about Claude’s API.</p>
<p>Most of the time you’ll see that we write some source code <em>first</em>, and then a description or discussion of it <em>afterwards</em>.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="f1ad998e-4bb1-4bed-abf4-6e8606cb2453" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># os.environ['ANTHROPIC_LOG'] = 'debug'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>To print every HTTP request and response in full, uncomment the above line. This functionality is provided by Anthropic’s SDK.</p>
<div id="af9ebbcf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> anthropic.types <span class="im">import</span> Model</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> claudette.text_editor <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> get_args</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cachy <span class="im">import</span> enable_cachy</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fbdea80a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>enable_cachy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="13866a72" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, message<span class="op">=</span><span class="st">"Pydantic serializer warnings"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re reading the rendered version of this notebook, you’ll see an “Exported source” collapsible widget below. If you’re reading the source notebook directly, you’ll see <code>#| exports</code> at the top of the cell. These show that this piece of code will be exported into the python module that this notebook creates. No other code will be included – any other code in this notebook is just for demonstration, documentation, and testing.</p>
<p>You can toggle expanding/collapsing the source code of all exported sections by using the <code>&lt;/&gt; Code</code> menu in the top right of the rendered notebook page.</p>
</div>
</div>
<div id="0fff8869" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>model_types <span class="op">=</span> {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Anthropic</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-opus-4-6'</span>: <span class="st">'opus'</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-sonnet-4-6'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-haiku-4-5'</span>: <span class="st">'haiku'</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-opus-4-5'</span>: <span class="st">'opus-4-5'</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-sonnet-4-5'</span>: <span class="st">'sonnet-4-5'</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-opus-4-1-20250805'</span>: <span class="st">'opus-4-1'</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-opus-4-20250514'</span>: <span class="st">'opus-4'</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-opus-20240229'</span>: <span class="st">'opus-3'</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-sonnet-4-20250514'</span>: <span class="st">'sonnet-4'</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-7-sonnet-20250219'</span>: <span class="st">'sonnet-3-7'</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-5-sonnet-20241022'</span>: <span class="st">'sonnet-3-5'</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-haiku-20240307'</span>: <span class="st">'haiku-3'</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-5-haiku-20241022'</span>: <span class="st">'haiku-3-5'</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AWS</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-opus-4-1-20250805-v1:0'</span>: <span class="st">'opus'</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-3-5-sonnet-20241022-v2:0'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-3-opus-20240229-v1:0'</span>: <span class="st">'opus-3'</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-3-sonnet-20240229-v1:0'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-3-haiku-20240307-v1:0'</span>: <span class="st">'haiku'</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Google</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-opus-4-1@20250805'</span>: <span class="st">'opus'</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-5-sonnet-v2@20241022'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-opus@20240229'</span>: <span class="st">'opus-3'</span>,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-sonnet@20240229'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-haiku@20240307'</span>: <span class="st">'haiku'</span>,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>all_models <span class="op">=</span> <span class="bu">list</span>(model_types)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="c8490b08" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>models</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['claude-opus-4-6',
 'claude-sonnet-4-6',
 'claude-haiku-4-5',
 'claude-opus-4-5',
 'claude-sonnet-4-5',
 'claude-opus-4-1-20250805',
 'claude-opus-4-20250514',
 'claude-3-opus-20240229',
 'claude-sonnet-4-20250514',
 'claude-3-7-sonnet-20250219']</code></pre>
</div>
</div>
<div id="669696aa" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>text_only_models <span class="op">=</span> (<span class="st">'claude-3-5-haiku-20241022'</span>,)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="2411f28d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>has_streaming_models <span class="op">=</span> <span class="bu">set</span>(all_models)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>has_system_prompt_models <span class="op">=</span> <span class="bu">set</span>(all_models)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>has_temperature_models <span class="op">=</span> <span class="bu">set</span>(all_models)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>has_extended_thinking_models <span class="op">=</span> {</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-opus-4-6'</span>, <span class="st">'claude-sonnet-4-6'</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-opus-4-5'</span>, <span class="st">'claude-sonnet-4-5'</span>, <span class="st">'claude-haiku-4-5'</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-opus-4-1-20250805'</span>, <span class="st">'claude-opus-4-20250514'</span>, <span class="st">'claude-sonnet-4-20250514'</span>, <span class="st">'claude-3-7-sonnet-20250219'</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="980bfdfb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>has_extended_thinking_models</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'claude-3-7-sonnet-20250219',
 'claude-haiku-4-5',
 'claude-opus-4-1-20250805',
 'claude-opus-4-20250514',
 'claude-opus-4-5',
 'claude-opus-4-6',
 'claude-sonnet-4-20250514',
 'claude-sonnet-4-5',
 'claude-sonnet-4-6'}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L112" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="can_use_extended_thinking" class="level3">
<h3 class="anchored" data-anchor-id="can_use_extended_thinking">can_use_extended_thinking</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> can_use_extended_thinking(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    m</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="12a68d54" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> can_stream(m): <span class="cf">return</span> m <span class="kw">in</span> has_streaming_models</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> can_set_system_prompt(m): <span class="cf">return</span> m <span class="kw">in</span> has_system_prompt_models</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> can_set_temperature(m): <span class="cf">return</span> m <span class="kw">in</span> has_temperature_models</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> can_use_extended_thinking(m): <span class="cf">return</span> m <span class="kw">in</span> has_extended_thinking_models</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L111" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="can_set_temperature" class="level3">
<h3 class="anchored" data-anchor-id="can_set_temperature">can_set_temperature</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> can_set_temperature(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    m</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L110" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="can_set_system_prompt" class="level3">
<h3 class="anchored" data-anchor-id="can_set_system_prompt">can_set_system_prompt</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> can_set_system_prompt(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    m</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L109" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="can_stream" class="level3">
<h3 class="anchored" data-anchor-id="can_stream">can_stream</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> can_stream(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    m</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We include these functions to provide a uniform library interface with cosette since openai models such as o1 do not have many of these capabilities.</p>
<div id="55036062" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> can_stream(<span class="st">'claude-3-5-sonnet-20241022'</span>) <span class="kw">and</span> can_set_system_prompt(<span class="st">'claude-3-5-sonnet-20241022'</span>) <span class="kw">and</span> can_set_temperature(<span class="st">'claude-3-5-sonnet-20241022'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>These are the current versions and <a href="https://www.anthropic.com/pricing#anthropic-api">prices</a> of Anthropic’s models at the time of writing.</p>
<div id="dacf2bd2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models[<span class="dv">1</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>model</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'claude-sonnet-4-6'</code></pre>
</div>
</div>
</section>
</section>
<section id="antropic-sdk" class="level2">
<h2 class="anchored" data-anchor-id="antropic-sdk">Antropic SDK</h2>
<div id="70b53a51" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>cli <span class="op">=</span> Anthropic()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This is what Anthropic’s SDK provides for interacting with Python. To use it, pass it a list of <em>messages</em>, with <em>content</em> and a <em>role</em>. The roles should alternate between <em>user</em> and <em>assistant</em>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>After the code below you’ll see an indented section with an orange vertical line on the left. This is used to show the <em>result</em> of running the code above. Because the code is running in a Jupyter Notebook, we don’t have to use <code>print</code> to display results, we can just type the expression directly, as we do with <code>r</code> here.</p>
</div>
</div>
<div id="6ec40731" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> {<span class="st">'role'</span>: <span class="st">'user'</span>, <span class="st">'content'</span>: <span class="st">"I'm Jeremy"</span>}</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> cli.messages.create(messages<span class="op">=</span>[m], model<span class="op">=</span>model, max_tokens<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Jeremy! Nice to meet you. How can I help you today?</p>
<details>
<ul>
<li>id: <code>msg_01Q3123HGtAxWnUraLL65H24</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Hi Jeremy! Nice to meet you. How can I help you today?', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 10, 'output_tokens': 18, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<section id="formatting-output" class="level3">
<h3 class="anchored" data-anchor-id="formatting-output">Formatting output</h3>
<p>That output is pretty long and hard to read, so let’s clean it up. We’ll start by pulling out the <code>Content</code> part of the message. To do that, we’re going to write our first function which will be included to the <code>claudette/core.py</code> module.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is the first exported public function or class we’re creating (the previous export was of a variable). In the rendered version of the notebook for these you’ll see 4 things, in this order (unless the symbol starts with a single <code>_</code>, which indicates it’s <em>private</em>):</p>
<ul>
<li>The signature (with the symbol name as a heading, with a horizontal rule above)</li>
<li>A table of paramater docs (if provided)</li>
<li>The doc string (in italics).</li>
<li>The source code (in a collapsible “Exported source” block)</li>
</ul>
<p>After that, we generally provide a bit more detail on what we’ve created, and why, along with a sample usage.</p>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L119" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="find_block" class="level3">
<h3 class="anchored" data-anchor-id="find_block">find_block</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_block(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    r:Mapping, <span class="co"># The message to look in</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    blk_type:<span class="bu">type</span> <span class="op">|</span> <span class="bu">str</span><span class="op">=</span>TextBlock, <span class="co"># The type of block to find</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Find the first block of type <code>blk_type</code> in <code>r.content</code>.</em></p>
<div id="eba620ce" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _type(x):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>: <span class="cf">return</span> x.<span class="bu">type</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">AttributeError</span>: <span class="cf">return</span> x.get(<span class="st">'type'</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_block(r:abc.Mapping, <span class="co"># The message to look in</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>               blk_type:<span class="bu">type</span><span class="op">|</span><span class="bu">str</span><span class="op">=</span>TextBlock  <span class="co"># The type of block to find</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>              ):</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Find the first block of type `blk_type` in `r.content`."</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> (<span class="kw">lambda</span> x:_type(x)<span class="op">==</span>blk_type) <span class="cf">if</span> <span class="bu">isinstance</span>(blk_type,<span class="bu">str</span>) <span class="cf">else</span> (<span class="kw">lambda</span> x:<span class="bu">isinstance</span>(x,blk_type))</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> first(o <span class="cf">for</span> o <span class="kw">in</span> r.content <span class="cf">if</span> f(o))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>This makes it easier to grab the needed parts of Claude’s responses, which can include multiple pieces of content. By default, we look for the first text block. That will generally have the content we want to display.</p>
<div id="10af0e65" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>find_block(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>TextBlock(citations=None, text='Hi Jeremy! Nice to meet you. How can I help you today?', type='text')</code></pre>
</div>
</div>
<div id="e021b725" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contents(r):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to get the contents from Claude response `r`."</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    blk <span class="op">=</span> find_block(r)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> blk <span class="kw">and</span> r.content: blk <span class="op">=</span> r.content[<span class="dv">0</span>]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(blk,<span class="st">'text'</span>): <span class="cf">return</span> blk.text.strip()</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(blk,<span class="st">'content'</span>): <span class="cf">return</span> blk.content.strip()</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(blk,<span class="st">'source'</span>): <span class="cf">return</span> <span class="ss">f'*Media Type - </span><span class="sc">{</span>blk<span class="sc">.</span><span class="bu">type</span><span class="sc">}</span><span class="ss">*'</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">str</span>(blk)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For display purposes, we often just want to show the text itself.</p>
<div id="6d5f2107" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>contents(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'Hi Jeremy! Nice to meet you. How can I help you today?'</code></pre>
</div>
</div>
<div id="17924d0c" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _repr_markdown_(<span class="va">self</span>:(Message)):</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    det <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">- '</span>.join(<span class="ss">f'</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: `</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">`'</span> <span class="cf">for</span> k,v <span class="kw">in</span> <span class="va">self</span>.model_dump().items())</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    cts <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="ch">\$</span><span class="vs">'</span>, <span class="st">'&amp;#36;'</span>, contents(<span class="va">self</span>))  <span class="co"># escape `$` for jupyter latex</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span><span class="sc">{</span>cts<span class="sc">}</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;details&gt;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="sc">{</span>det<span class="sc">}</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;/details&gt;"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Jupyter looks for a <code>_repr_markdown_</code> method in displayed objects; we add this in order to display just the content text, and collapse full details into a hideable section. Note that <code>patch</code> is from <a href="https://fastcore.fast.ai/">fastcore</a>, and is used to add (or replace) functionality in an existing class. We pass the class(es) that we want to patch as type annotations to <code>self</code>. In this case, <code>_repr_markdown_</code> is being added to Anthropic’s <code>Message</code> class, so when we display the message now we just see the contents, and the details are hidden away in a collapsible details block.</p>
<div id="cfd85eeb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Jeremy! Nice to meet you. How can I help you today?</p>
<details>
<ul>
<li>id: <code>msg_01Q3123HGtAxWnUraLL65H24</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Hi Jeremy! Nice to meet you. How can I help you today?', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 10, 'output_tokens': 18, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>One key part of the response is the <a href="https://claudette.answer.ai/core.html#usage"><code>usage</code></a> key, which tells us how many tokens we used by returning a <code>Usage</code> object.</p>
<p>We’ll add some helpers to make things a bit cleaner for creating and formatting these objects.</p>
<div id="10c7466f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>r.usage</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 10; Out: 18; Cache create: 0; Cache read: 0; Total Tokens: 28; Search: 0</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L140" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="server_tool_usage" class="level3">
<h3 class="anchored" data-anchor-id="server_tool_usage">server_tool_usage</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> server_tool_usage(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    web_search_requests:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, web_fetch_requests:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Little helper to create a server tool usage object</em></p>
<div id="56d7e83f" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> server_tool_usage(web_search_requests<span class="op">=</span><span class="dv">0</span>, web_fetch_requests<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'Little helper to create a server tool usage object'</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ServerToolUsage(web_search_requests<span class="op">=</span>web_search_requests, web_fetch_requests<span class="op">=</span>web_fetch_requests)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="89082253" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>server_tool_usage(<span class="dv">3</span>,<span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>ServerToolUsage(web_fetch_requests=2, web_search_requests=3)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L145" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage" class="level3">
<h3 class="anchored" data-anchor-id="usage">usage</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> usage(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    inp:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># input tokens</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    out:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Output tokens</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    cache_create:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Cache creation tokens</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    cache_read:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Cache read tokens</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    server_tool_use:ServerToolUsage<span class="op">=</span>ServerToolUsage(web_fetch_requests<span class="op">=</span><span class="dv">0</span>, web_search_requests<span class="op">=</span><span class="dv">0</span>), <span class="co"># server tool use</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Slightly more concise version of <code>Usage</code>.</em></p>
<div id="b1a24f68" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> usage(inp<span class="op">=</span><span class="dv">0</span>, <span class="co"># input tokens</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>          out<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Output tokens</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>          cache_create<span class="op">=</span><span class="dv">0</span>, <span class="co"># Cache creation tokens</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>          cache_read<span class="op">=</span><span class="dv">0</span>, <span class="co"># Cache read tokens</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>          server_tool_use<span class="op">=</span>server_tool_usage() <span class="co"># server tool use</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>         ):</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">'Slightly more concise version of `Usage`.'</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Usage(input_tokens<span class="op">=</span>inp, output_tokens<span class="op">=</span>out, cache_creation_input_tokens<span class="op">=</span>cache_create,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                 cache_read_input_tokens<span class="op">=</span>cache_read, server_tool_use<span class="op">=</span>server_tool_use)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The constructor provided by Anthropic is rather verbose, so we clean it up a bit, using a lowercase version of the name.</p>
<div id="a7e52afd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>usage(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 5; Out: 0; Cache create: 0; Cache read: 0; Total Tokens: 5; Search: 0</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L161" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage.total" class="level3">
<h3 class="anchored" data-anchor-id="usage.total">Usage.total</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> total(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="2db64da5" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _dgetattr(o,s,d): </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Like getattr, but returns the default if the result is None"</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">getattr</span>(o,s,d) <span class="kw">or</span> d</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> total(<span class="va">self</span>:Usage): <span class="cf">return</span> <span class="va">self</span>.input_tokens<span class="op">+</span><span class="va">self</span>.output_tokens<span class="op">+</span>_dgetattr(<span class="va">self</span>, <span class="st">"cache_creation_input_tokens"</span>,<span class="dv">0</span>)<span class="op">+</span>_dgetattr(<span class="va">self</span>, <span class="st">"cache_read_input_tokens"</span>,<span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Adding a <code>total</code> property to <code>Usage</code> makes it easier to see how many tokens we’ve used up altogether.</p>
<div id="74553203" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>usage(<span class="dv">5</span>,<span class="dv">1</span>).total</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>6</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L165" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage.__repr__" class="level3">
<h3 class="anchored" data-anchor-id="usage.__repr__">Usage.__repr__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__repr__</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Return repr(self).</em></p>
<div id="27468180" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>:Usage):</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    io_toks <span class="op">=</span> <span class="ss">f'In: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>input_tokens<span class="sc">}</span><span class="ss">; Out: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>output_tokens<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    cache_toks <span class="op">=</span> <span class="ss">f'Cache create: </span><span class="sc">{</span>_dgetattr(<span class="va">self</span>, <span class="st">"cache_creation_input_tokens"</span>,<span class="dv">0</span>)<span class="sc">}</span><span class="ss">; Cache read: </span><span class="sc">{</span>_dgetattr(<span class="va">self</span>, <span class="st">"cache_read_input_tokens"</span>,<span class="dv">0</span>)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    server_tool_use <span class="op">=</span> _dgetattr(<span class="va">self</span>, <span class="st">"server_tool_use"</span>,server_tool_usage())</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    server_tool_use_str <span class="op">=</span> <span class="ss">f'Search: </span><span class="sc">{</span>server_tool_use<span class="sc">.</span>web_search_requests<span class="sc">}</span><span class="ss">; Fetch: </span><span class="sc">{</span>server_tool_use<span class="sc">.</span>web_fetch_requests<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    total_tok <span class="op">=</span> <span class="ss">f'Total Tokens: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>total<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span>io_toks<span class="sc">}</span><span class="ss">; </span><span class="sc">{</span>cache_toks<span class="sc">}</span><span class="ss">; </span><span class="sc">{</span>total_tok<span class="sc">}</span><span class="ss">; </span><span class="sc">{</span>server_tool_use_str<span class="sc">}</span><span class="ss">'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>In python, patching <code>__repr__</code> lets us change how an object is displayed. (More generally, methods starting and ending in <code>__</code> in Python are called <code>dunder</code> methods, and have some <code>magic</code> behavior – such as, in this case, changing how an object is displayed.) We won’t be directly displaying ServerToolUsage’s, so we can handle its display behavior in the same Usage <code>__repr__</code></p>
<div id="b8af5068" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>usage(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 5; Out: 0; Cache create: 0; Cache read: 0; Total Tokens: 5; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L175" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="servertoolusage.__add__" class="level3">
<h3 class="anchored" data-anchor-id="servertoolusage.__add__">ServerToolUsage.__add__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__add__</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    b</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Add together each of the server tool use counts</em></p>
<div id="4a9886af" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>:ServerToolUsage, b):</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add together each of the server tool use counts"</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ServerToolUsage(web_search_requests<span class="op">=</span><span class="va">self</span>.web_search_requests<span class="op">+</span>b.web_search_requests,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        web_fetch_requests<span class="op">=</span><span class="va">self</span>.web_fetch_requests<span class="op">+</span>b.web_fetch_requests)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>And, patching <code>__add__</code> lets <code>+</code> work on a <code>ServerToolUsage</code> as well as a <code>Usage</code> object.</p>
<div id="facab8cd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>server_tool_usage(<span class="dv">1</span>) <span class="op">+</span> server_tool_usage(<span class="dv">2</span>,<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>ServerToolUsage(web_fetch_requests=3, web_search_requests=3)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L182" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage.__add__" class="level3">
<h3 class="anchored" data-anchor-id="usage.__add__">Usage.__add__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__add__</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    b</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Add together each of <code>input_tokens</code> and <code>output_tokens</code></em></p>
<div id="6c9025c6" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>:Usage, b):</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add together each of `input_tokens` and `output_tokens`"</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> usage(<span class="va">self</span>.input_tokens<span class="op">+</span>b.input_tokens, <span class="va">self</span>.output_tokens<span class="op">+</span>b.output_tokens,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                 _dgetattr(<span class="va">self</span>,<span class="st">'cache_creation_input_tokens'</span>,<span class="dv">0</span>)<span class="op">+</span>_dgetattr(b,<span class="st">'cache_creation_input_tokens'</span>,<span class="dv">0</span>),</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                 _dgetattr(<span class="va">self</span>,<span class="st">'cache_read_input_tokens'</span>,<span class="dv">0</span>)<span class="op">+</span>_dgetattr(b,<span class="st">'cache_read_input_tokens'</span>,<span class="dv">0</span>),</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                 _dgetattr(<span class="va">self</span>,<span class="st">'server_tool_use'</span>,server_tool_usage())<span class="op">+</span>_dgetattr(b,<span class="st">'server_tool_use'</span>,server_tool_usage()))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="bffb0b2e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>r.usage<span class="op">+</span>r.usage <span class="op">+</span> usage(server_tool_use<span class="op">=</span>server_tool_usage(<span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 20; Out: 36; Cache create: 0; Cache read: 0; Total Tokens: 56; Search: 1; Fetch: 0</code></pre>
</div>
</div>
</section>
<section id="creating-messages" class="level3">
<h3 class="anchored" data-anchor-id="creating-messages">Creating messages</h3>
<p>Creating correctly formatted <code>dict</code>s from scratch every time isn’t very handy, so we’ll import a couple of helper functions from the <code>msglm</code> library.</p>
<p>Let’s use <code>mk_msg</code> to recreate our msg <code>{'role': 'user', 'content': "I'm Jeremy"}</code> from earlier.</p>
<div id="0ffa2c14" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"I'm Jeremy"</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> mk_msg(prompt)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> cli.messages.create(messages<span class="op">=</span>[m], model<span class="op">=</span>model, max_tokens<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Jeremy! Nice to meet you. How can I help you today?</p>
<details>
<ul>
<li>id: <code>msg_01Q3123HGtAxWnUraLL65H24</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Hi Jeremy! Nice to meet you. How can I help you today?', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 10, 'output_tokens': 18, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>We can pass more than just text messages to Claude. As we’ll see later we can also pass images, SDK objects, etc. To handle these different data types we need to pass the type along with our content to Claude.</p>
<p>Here”s an example of a multimodal message containing text and images.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"role"</span><span class="fu">:</span> <span class="st">"user"</span><span class="fu">,</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"content"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span><span class="dt">"type"</span><span class="fu">:</span><span class="st">"text"</span><span class="fu">,</span> <span class="dt">"text"</span><span class="fu">:</span><span class="st">"What is in the image?"</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"type"</span><span class="fu">:</span><span class="st">"image"</span><span class="fu">,</span> </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"source"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                <span class="dt">"type"</span><span class="fu">:</span><span class="st">"base64"</span><span class="fu">,</span> <span class="dt">"media_type"</span><span class="fu">:</span><span class="st">"media_type"</span><span class="fu">,</span> <span class="dt">"data"</span><span class="fu">:</span> <span class="st">"data"</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>mk_msg</code> infers the type automatically and creates the appropriate data structure.</p>
<p>LLMs, don’t actually have state, but instead dialogs are created by passing back all previous prompts and responses every time. With Claude, they always alternate <em>user</em> and <em>assistant</em>. We’ll use <code>mk_msgs</code> from <code>msglm</code> to make it easier to build up these dialog lists.</p>
<div id="b4c8fcad" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([prompt, r, <span class="st">"I forgot my name. Can you remind me please?"</span>]) </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': "I'm Jeremy"},
 {'role': 'assistant',
  'content': [TextBlock(citations=None, text='Hi Jeremy! Nice to meet you. How can I help you today?', type='text')]},
 {'role': 'user', 'content': 'I forgot my name. Can you remind me please?'}]</code></pre>
</div>
</div>
<div id="6c464f8b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>cli.messages.create(messages<span class="op">=</span>msgs, model<span class="op">=</span>model, max_tokens<span class="op">=</span><span class="dv">200</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Jeremy! You told me that at the start of our conversation. 😊</p>
<details>
<ul>
<li>id: <code>msg_01QTvdUwQAyKRQT3H73STdU3</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Your name is Jeremy! You told me that at the start of our conversation. 😊', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 42, 'output_tokens': 22, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="client" class="level2">
<h2 class="anchored" data-anchor-id="client">Client</h2>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L190" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="client-1" class="level3">
<h3 class="anchored" data-anchor-id="client-1">Client</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Client(</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    model, cli:NoneType<span class="op">=</span><span class="va">None</span>, log:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, cache:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Basic Anthropic messages client.</em></p>
<div id="3b873aaf" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Client:</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, cli<span class="op">=</span><span class="va">None</span>, log<span class="op">=</span><span class="va">False</span>, cache<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Basic Anthropic messages client."</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model,<span class="va">self</span>.use <span class="op">=</span> model,usage()</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.text_only <span class="op">=</span> model <span class="kw">in</span> text_only_models</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> [] <span class="cf">if</span> log <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.c <span class="op">=</span> (cli <span class="kw">or</span> Anthropic(default_headers<span class="op">=</span>{<span class="st">'anthropic-beta'</span>: <span class="st">'prompt-caching-2024-07-31'</span>}))</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cache <span class="op">=</span> cache</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We’ll create a simple <a href="https://claudette.answer.ai/core.html#client"><code>Client</code></a> for <code>Anthropic</code> which tracks usage stores the model to use. We don’t add any methods right away – instead we’ll use <code>patch</code> for that so we can add and document them incrementally.</p>
<div id="d01e9ccf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Client(model)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>c.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 0; Out: 0; Cache create: 0; Cache read: 0; Total Tokens: 0; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<div id="8015d3f3" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _r(<span class="va">self</span>:Client, r:Message, prefill<span class="op">=</span><span class="st">''</span>):</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Store the result of the message and accrue total usage."</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prefill:</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>        blk <span class="op">=</span> find_block(r)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> blk: blk.text <span class="op">=</span> prefill <span class="op">+</span> (blk.text <span class="kw">or</span> <span class="st">''</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.result <span class="op">=</span> r</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.use <span class="op">+=</span> r.usage</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.stop_reason <span class="op">=</span> r.stop_reason</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.stop_sequence <span class="op">=</span> r.stop_sequence</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We use a <code>_</code> prefix on private methods, but we document them here in the interests of literate source code.</p>
<p><code>_r</code> will be used each time we get a new result, to track usage and also to keep the result available for later.</p>
<div id="0181f7b3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>c._r(r)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>c.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 10; Out: 18; Cache create: 0; Cache read: 0; Total Tokens: 28; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<p>Whereas OpenAI’s models use a <code>stream</code> parameter for streaming, Anthropic’s use a separate method. We implement Anthropic’s approach in a private method, and then use a <code>stream</code> parameter in <code>__call__</code> for consistency:</p>
<div id="6520a355" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _log(<span class="va">self</span>:Client, final, prefill, msgs, <span class="op">**</span>kwargs):</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._r(final, prefill)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.log <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: <span class="va">self</span>.log.append({</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"msgs"</span>: msgs, <span class="op">**</span>kwargs,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"result"</span>: <span class="va">self</span>.result, <span class="st">"use"</span>: <span class="va">self</span>.use, <span class="st">"stop_reason"</span>: <span class="va">self</span>.stop_reason, <span class="st">"stop_sequence"</span>: <span class="va">self</span>.stop_sequence</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Once streaming is complete, we need to store the final message and call any completion callback that’s needed.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L232" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_types" class="level3">
<h3 class="anchored" data-anchor-id="get_types">get_types</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_types(</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    msgs</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="958b7d6b" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="at">@save_iter</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _stream(o, cm, prefill, cb):</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> cm <span class="im">as</span> s:</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> prefill</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> <span class="cf">from</span> s.text_stream</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>        o.value <span class="op">=</span> s.get_final_message()</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>        cb(o.value)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="9e8f15b4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>get_types(msgs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['text', 'text', 'text']</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L241" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tool_choice" class="level3">
<h3 class="anchored" data-anchor-id="mk_tool_choice">mk_tool_choice</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tool_choice(</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    choose:Union</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Create a <code>tool_choice</code> dict that’s ‘auto’ if <code>choose</code> is <code>None</code>, ‘any’ if it is True, or ‘tool’ otherwise</em></p>
<div id="59466964" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mk_tool_choice(<span class="st">'sums'</span>))</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mk_tool_choice(<span class="va">True</span>))</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mk_tool_choice(<span class="va">None</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'type': 'tool', 'name': 'sums'}
{'type': 'any'}
{'type': 'auto'}</code></pre>
</div>
</div>
<p>Claude can be forced to use a particular tool, or select from a specific list of tools, or decide for itself when to use a tool. If you want to force a tool (or force choosing from a list), include a <code>tool_choice</code> param with a dict from <a href="https://claudette.answer.ai/core.html#mk_tool_choice"><code>mk_tool_choice</code></a>.</p>
<p>Claude supports adding an extra <code>assistant</code> message at the end, which contains the <em>prefill</em> – i.e.&nbsp;the text we want Claude to assume the response starts with. However Claude doesn’t actually repeat that in the response, so for convenience we add it.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L267" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="client.__call__" class="level3">
<h3 class="anchored" data-anchor-id="client.__call__">Client.__call__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    msgs:<span class="bu">list</span>, <span class="co"># List of messages in the dialog</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    sp:<span class="bu">str</span><span class="op">=</span><span class="st">''</span>, <span class="co"># The system prompt</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    temp:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    maxtok:<span class="bu">int</span><span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    maxthinktok:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Maximum thinking tokens</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    prefill:<span class="bu">str</span><span class="op">=</span><span class="st">''</span>, <span class="co"># Optional prefill to pass to Claude as start of its response</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    stop:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Stop sequence</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    tools:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># List of tools to make available to Claude</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    tool_choice:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Optionally force use of some tool</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    cb:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Callback to pass result to when complete</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    cache_control:Optional[CacheControlEphemeralParam] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    container:Optional[<span class="bu">str</span>] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    inference_geo:Optional[<span class="bu">str</span>] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    metadata:MetadataParam <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>    output_config:OutputConfigParam <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>    service_tier:Literal[<span class="st">'auto'</span>, <span class="st">'standard_only'</span>] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>    stop_sequences:SequenceNotStr[<span class="bu">str</span>] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>    system:Union[<span class="bu">str</span>, Iterable[TextBlockParam]] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    temperature:<span class="bu">float</span> <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    thinking:ThinkingConfigParam <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>    top_k:<span class="bu">int</span> <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>    top_p:<span class="bu">float</span> <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>    extra_headers:Headers <span class="op">|</span> <span class="va">None</span><span class="op">=</span><span class="va">None</span>, <span class="co"># Use the following arguments if you need to pass additional parameters to the API that aren't available via kwargs.</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>The extra values given here take precedence over values defined on the client <span class="kw">or</span> passed to this method.</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>    extra_query:Query <span class="op">|</span> <span class="va">None</span><span class="op">=</span><span class="va">None</span>, extra_body:Body <span class="op">|</span> <span class="va">None</span><span class="op">=</span><span class="va">None</span>,</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    timeout:<span class="bu">float</span> <span class="op">|</span> httpx.Timeout <span class="op">|</span> <span class="va">None</span> <span class="op">|</span> NotGiven<span class="op">=</span>NOT_GIVEN</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Make a call to Claude.</em></p>
<div id="b1604237" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _precall(<span class="va">self</span>:Client, msgs, prefill, sp, temp, maxtok, maxthinktok, stream,</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>             stop, tools, tool_choice, kwargs):</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tools: kwargs[<span class="st">'tools'</span>] <span class="op">=</span> [get_schema(o) <span class="cf">if</span> <span class="bu">callable</span>(o) <span class="cf">else</span> o <span class="cf">for</span> o <span class="kw">in</span> listify(tools)]</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tool_choice: kwargs[<span class="st">'tool_choice'</span>] <span class="op">=</span> mk_tool_choice(tool_choice)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> maxthinktok: </span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>        kwargs[<span class="st">'thinking'</span>] <span class="op">=</span> {<span class="st">'type'</span>:<span class="st">'enabled'</span>, <span class="st">'budget_tokens'</span>:maxthinktok} </span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>        temp,prefill <span class="op">=</span> <span class="dv">1</span>,<span class="st">''</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    pref <span class="op">=</span> [prefill.strip()] <span class="cf">if</span> prefill <span class="cf">else</span> []</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(msgs,<span class="bu">list</span>): msgs <span class="op">=</span> [msgs]</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stop <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(stop, (<span class="bu">list</span>)): stop <span class="op">=</span> [stop]</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>        kwargs[<span class="st">"stop_sequences"</span>] <span class="op">=</span> stop</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    msgs <span class="op">=</span> mk_msgs(msgs<span class="op">+</span>pref, cache<span class="op">=</span><span class="va">self</span>.cache, cache_last_ckpt_only<span class="op">=</span><span class="va">self</span>.cache)</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="kw">not</span> (<span class="st">'image'</span> <span class="kw">in</span> get_types(msgs) <span class="kw">and</span> <span class="va">self</span>.text_only), <span class="ss">f"Images not supported by: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>model<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    kwargs <span class="op">|=</span> <span class="bu">dict</span>(max_tokens<span class="op">=</span>maxtok, system<span class="op">=</span>sp, temperature<span class="op">=</span>temp)</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> msgs, kwargs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="95bddb45" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(messages.Messages.create)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>:Client,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>             msgs:<span class="bu">list</span>, <span class="co"># List of messages in the dialog</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>             sp<span class="op">=</span><span class="st">''</span>, <span class="co"># The system prompt</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>             temp<span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>             maxtok<span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>             maxthinktok<span class="op">=</span><span class="dv">0</span>, <span class="co"># Maximum thinking tokens</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>             prefill<span class="op">=</span><span class="st">''</span>, <span class="co"># Optional prefill to pass to Claude as start of its response</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>             stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>             stop<span class="op">=</span><span class="va">None</span>, <span class="co"># Stop sequence</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>             tools:Optional[<span class="bu">list</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># List of tools to make available to Claude</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>             tool_choice:Optional[<span class="bu">dict</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># Optionally force use of some tool</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>             cb<span class="op">=</span><span class="va">None</span>, <span class="co"># Callback to pass result to when complete</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>             <span class="op">**</span>kwargs):</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Make a call to Claude."</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    msgs,kwargs <span class="op">=</span> <span class="va">self</span>._precall(msgs, prefill, sp, temp, maxtok, maxthinktok, stream,</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>                                stop, tools, tool_choice, kwargs)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> <span class="va">self</span>.c.messages</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> m.stream <span class="cf">if</span> stream <span class="cf">else</span> m.create</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> f(model<span class="op">=</span><span class="va">self</span>.model, messages<span class="op">=</span>msgs, <span class="op">**</span>kwargs)</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _cb(v):</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._log(v, prefill<span class="op">=</span>prefill, msgs<span class="op">=</span>msgs, <span class="op">**</span>kwargs)</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cb: cb(v)</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stream: <span class="cf">return</span> _stream(res, prefill, _cb)</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>: <span class="cf">return</span> res</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>: _cb(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Defining <code>__call__</code> let’s us use an object like a function (i.e it’s <em>callable</em>). We use it as a small wrapper over <code>messages.create</code>.</p>
<div id="881b5e78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Client(model, log<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>c.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 0; Out: 0; Cache create: 0; Cache read: 0; Total Tokens: 0; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<div id="e74fc422" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>c(<span class="st">'Hi'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi there! How are you doing? Is there something I can help you with today? 😊</p>
<details>
<ul>
<li>id: <code>msg_01NSbD7ZmQJKeY16gJ6apjAH</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Hi there! How are you doing? Is there something I can help you with today? 😊', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 8, 'output_tokens': 24, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>Usage details are automatically updated after each call:</p>
<div id="ae9f7e06" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>c.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 8; Out: 24; Cache create: 0; Cache read: 0; Total Tokens: 32; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<p>A log of all messages is kept if <code>log=True</code> is passed:</p>
<div id="6ba81866" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>pprint(c.log)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'max_tokens': 4096,
  'msgs': [{'content': 'Hi', 'role': 'user'}],
  'result': Message(id='msg_01NSbD7ZmQJKeY16gJ6apjAH', container=None, content=[TextBlock(citations=None, text='Hi there! How are you doing? Is there something I can help you with today? 😊', type='text')], model='claude-sonnet-4-6', role='assistant', stop_reason='end_turn', stop_sequence=None, type='message', usage=In: 8; Out: 24; Cache create: 0; Cache read: 0; Total Tokens: 32; Search: 0; Fetch: 0),
  'stop_reason': 'end_turn',
  'stop_sequence': None,
  'system': '',
  'temperature': 0,
  'use': In: 8; Out: 24; Cache create: 0; Cache read: 0; Total Tokens: 32; Search: 0; Fetch: 0}]</code></pre>
</div>
</div>
<div id="bd935215" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>c.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 8; Out: 24; Cache create: 0; Cache read: 0; Total Tokens: 32; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<p>We can pass <code>stream=True</code> to stream the response back incrementally:</p>
<div id="e281399f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(<span class="st">'Hi'</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r: <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hi there! How are you doing? Is there something I can help you with today? 😊</code></pre>
</div>
</div>
<div id="beb25f2a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>c.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 16; Out: 48; Cache create: 0; Cache read: 0; Total Tokens: 64; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<p>The full final message after completion of streaming is in the <code>value</code> attr of the response:</p>
<div id="a198fe54" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>r.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi there! How are you doing? Is there something I can help you with today? 😊</p>
<details>
<ul>
<li>id: <code>msg_01Nu7hy5Yi1KdQXg48jpFVCS</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Hi there! How are you doing? Is there something I can help you with today? 😊', 'type': 'text', 'parsed_output': None}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 8, 'output_tokens': 24, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>Pass a stop sequence if you want claude to stop generating text when it encounters it.</p>
<div id="12b17591" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>c(<span class="st">"Count from 1 to 10"</span>, stop<span class="op">=</span><span class="st">"5"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Here are the numbers from 1 to 10:</p>
<p>1, 2, 3, 4,</p>
<details>
<ul>
<li>id: <code>msg_01UNUPpjNHteRG8DTrSUw4Hm</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Here are the numbers from 1 to 10:\n\n1, 2, 3, 4, ', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>stop_sequence</code></li>
<li>stop_sequence: <code>5</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 15, 'output_tokens': 26, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>This also works with streaming, and you can pass more than one stop sequence:</p>
<div id="ff50577d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> c(<span class="st">"Count from 1 to 10"</span>, stop<span class="op">=</span>[<span class="st">"3"</span>, <span class="st">"yellow"</span>], stream<span class="op">=</span><span class="va">True</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(c.stop_reason, c.stop_sequence)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Here is counting from 1 to 10:

1, 2, 
stop_sequence 3</code></pre>
</div>
</div>
<p>We’ve shown the token usage but we really care about is pricing. Let’s extract the latest <a href="https://www.anthropic.com/pricing#anthropic-api">pricing</a> from Anthropic into a <code>pricing</code> dict.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L303" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_pricing" class="level3">
<h3 class="anchored" data-anchor-id="get_pricing">get_pricing</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_pricing(</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    m, u</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="2a1f2e67" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_pricing(m, u):</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pricing[m][:<span class="dv">3</span>] <span class="cf">if</span> u.prompt_token_count <span class="op">&lt;</span> <span class="dv">128_000</span> <span class="cf">else</span> pricing[m][<span class="dv">3</span>:]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Similarly, let’s get the pricing for the latest <a href="">server tools</a>:</p>
<p>We’ll patch <code>Usage</code> to enable it compute the cost given pricing.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L313" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage.cost" class="level3">
<h3 class="anchored" data-anchor-id="usage.cost">Usage.cost</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    costs:<span class="bu">tuple</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">float</span>:</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="2edb5da5" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(<span class="va">self</span>:Usage, costs:<span class="bu">tuple</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    cache_w, cache_r <span class="op">=</span> _dgetattr(<span class="va">self</span>, <span class="st">"cache_creation_input_tokens"</span>,<span class="dv">0</span>), _dgetattr(<span class="va">self</span>, <span class="st">"cache_read_input_tokens"</span>,<span class="dv">0</span>)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    tok_cost <span class="op">=</span> <span class="bu">sum</span>([<span class="va">self</span>.input_tokens <span class="op">*</span> costs[<span class="dv">0</span>] <span class="op">+</span>  <span class="va">self</span>.output_tokens <span class="op">*</span> costs[<span class="dv">1</span>] <span class="op">+</span>  cache_w <span class="op">*</span> costs[<span class="dv">2</span>] <span class="op">+</span> cache_r <span class="op">*</span> costs[<span class="dv">3</span>]]) <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    server_tool_use <span class="op">=</span> _dgetattr(<span class="va">self</span>, <span class="st">"server_tool_use"</span>,server_tool_usage())</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    server_tool_cost <span class="op">=</span> server_tool_use.web_search_requests <span class="op">*</span> server_tool_pricing[<span class="st">'web_search_requests'</span>] <span class="op">/</span> <span class="fl">1e3</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tok_cost <span class="op">+</span> server_tool_cost</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L322" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="client.cost" class="level3">
<h3 class="anchored" data-anchor-id="client.cost">Client.cost</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">float</span>:</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="936a4adc" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(<span class="va">self</span>: Client) <span class="op">-&gt;</span> <span class="bu">float</span>: <span class="cf">return</span> <span class="va">self</span>.use.cost(pricing[model_types[<span class="va">self</span>.model]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L325" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_costs" class="level3">
<h3 class="anchored" data-anchor-id="get_costs">get_costs</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_costs(</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    c</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="91d4dcbe" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_costs(c):</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>    costs <span class="op">=</span> pricing[model_types[c.model]]</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    inp_cost <span class="op">=</span> c.use.input_tokens <span class="op">*</span> costs[<span class="dv">0</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    out_cost <span class="op">=</span> c.use.output_tokens <span class="op">*</span> costs[<span class="dv">1</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    cache_w <span class="op">=</span> c.use.cache_creation_input_tokens   </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>    cache_r <span class="op">=</span> c.use.cache_read_input_tokens</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    cache_cost <span class="op">=</span> (cache_w <span class="op">*</span> costs[<span class="dv">2</span>] <span class="op">+</span> cache_r <span class="op">*</span> costs[<span class="dv">3</span>]) <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>    server_tool_use <span class="op">=</span> c.use.server_tool_use</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    server_tool_cost <span class="op">=</span> server_tool_use.web_search_requests <span class="op">*</span> server_tool_pricing[<span class="st">'web_search_requests'</span>] <span class="op">/</span> <span class="fl">1e3</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inp_cost, out_cost, cache_cost, cache_w <span class="op">+</span> cache_r, server_tool_cost</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The markdown repr of the client itself will show the latest result, along with the usage so far.</p>
<div id="15695891" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _repr_markdown_(<span class="va">self</span>:Client):</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>,<span class="st">'result'</span>): <span class="cf">return</span> <span class="st">'No results yet'</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    msg <span class="op">=</span> contents(<span class="va">self</span>.result)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    inp_cost, out_cost, cache_cost, cached_toks, server_tool_cost <span class="op">=</span> get_costs(<span class="va">self</span>)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span><span class="sc">{</span>msg<span class="sc">}</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="ss">| Metric | Count | Cost (USD) |</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="ss">|--------|------:|-----:|</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="ss">| Input tokens | </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>use<span class="sc">.</span>input_tokens<span class="sc">:,}</span><span class="ss"> | </span><span class="sc">{</span>inp_cost<span class="sc">:.6f}</span><span class="ss"> |</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="ss">| Output tokens | </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>use<span class="sc">.</span>output_tokens<span class="sc">:,}</span><span class="ss"> | </span><span class="sc">{</span>out_cost<span class="sc">:.6f}</span><span class="ss"> |</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="ss">| Cache tokens | </span><span class="sc">{</span>cached_toks<span class="sc">:,}</span><span class="ss"> | </span><span class="sc">{</span>cache_cost<span class="sc">:.6f}</span><span class="ss"> |</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a><span class="ss">| Server tool use | </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>use<span class="sc">.</span>server_tool_use<span class="sc">.</span>web_search_requests<span class="sc">:,}</span><span class="ss"> | </span><span class="sc">{</span>server_tool_cost<span class="sc">:.6f}</span><span class="ss"> |</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="ss">| **Total** | **</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>use<span class="sc">.</span>total<span class="sc">:,}</span><span class="ss">** | **$</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>cost<span class="sc">:.6f}</span><span class="ss">** |"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="be86fc43" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>c</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Here is counting from 1 to 10:</p>
<p>1, 2,</p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Cost (USD)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input tokens</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">0.000138</td>
</tr>
<tr class="even">
<td>Output tokens</td>
<td style="text-align: right;">93</td>
<td style="text-align: right;">0.001395</td>
</tr>
<tr class="odd">
<td>Cache tokens</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td>Server tool use</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td><strong>Total</strong></td>
<td style="text-align: right;"><strong>139</strong></td>
<td style="text-align: right;"><strong>$0.001533</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Pass a list of alternating user/assistant messages to give Claude a “dialog”.</p>
<div id="0a683725" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>c([<span class="st">"My name is Jeremy"</span>, <span class="st">"Hi Jeremy!"</span>, <span class="st">"Can you remind me what my name is?"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Jeremy! You told me that at the start of our conversation.</p>
<details>
<ul>
<li>id: <code>msg_01UF9i1HRnHDXaMHvNdWJJwf</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Your name is Jeremy! You told me that at the start of our conversation.', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 29, 'output_tokens': 19, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="tool-use" class="level2">
<h2 class="anchored" data-anchor-id="tool-use">Tool use</h2>
<p>Let’s now look more at tool use (aka <em>function calling</em>).</p>
<p>For testing, we need a function that Claude can call; we’ll write a simple function that adds numbers together, and will tell us when it’s being called:</p>
<div id="046e8cc3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MySum: val:<span class="bu">int</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sums(</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    a:<span class="bu">int</span>,  <span class="co"># First thing to sum</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    b:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span> <span class="co"># Second thing to sum</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>: <span class="co"># The sum of the inputs</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Adds a + b."</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Finding the sum of </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MySum(a <span class="op">+</span> b)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d51f2bdf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>a,b <span class="op">=</span> <span class="dv">604542</span>,<span class="dv">6458932</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?"</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"Always use tools when calculations are required."</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Claudette can autogenerate a schema thanks to the <code>toolslm</code> library. We’ll force the use of the tool using the function we created earlier.</p>
<div id="bff81d52" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>tools<span class="op">=</span>[get_schema(sums)]</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>choice <span class="op">=</span> mk_tool_choice(<span class="st">'sums'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We’ll start a dialog with Claude now. We’ll store the messages of our dialog in <code>msgs</code>. The first message will be our prompt <code>pr</code>, and we’ll pass our <code>tools</code> schema.</p>
<div id="c2ceeb75" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs(pr)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(msgs, sp<span class="op">=</span>sp, tools<span class="op">=</span>tools, tool_choice<span class="op">=</span>choice)</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ToolUseBlock(id=‘toolu_01Rk1eL2Zkx92c4c3FJJAjFu’, caller=DirectCaller(type=‘direct’), input={‘a’: 604542, ‘b’: 6458932}, name=‘sums’, type=‘tool_use’)</p>
<details>
<ul>
<li>id: <code>msg_01KK6wvRhJM93T4ZMo5XtYqZ</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu', 'caller': {'type': 'direct'}, 'input': {'a': 604542, 'b': 6458932}, 'name': 'sums', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 720, 'output_tokens': 57, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>When Claude decides that it should use a tool, it passes back a <code>ToolUseBlock</code> with the name of the tool to call, and the params to use.</p>
<p>We don’t want to allow it to call just any possible function (that would be a security disaster!) so we create a <em>namespace</em> – that is, a dictionary of allowable function names to call.</p>
<div id="4fb9826f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>ns <span class="op">=</span> mk_ns(sums)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>ns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'sums': &lt;function __main__.sums(a: int, b: int = 1) -&gt; int&gt;}</code></pre>
</div>
</div>
<p><a href="https://claudette.answer.ai/core.html#toolresult"><code>ToolResult</code></a> is used for two special cases:</p>
<ol type="1">
<li><p>When tool calls are RPCs with claudette running on an application server and code execution happening elsewhere, wrapping with a <code>result_type</code> field is used as a type descriptor for the claudette client.</p></li>
<li><p>Different types are handled in message history with specific format, so <a href="https://claudette.answer.ai/core.html#mk_funcres"><code>mk_funcres</code></a> branches the Anthropic representation (see depending on the <code>result_type</code>.</p></li>
</ol>
<p>Currently images are the only supported tool result type - see https://docs.anthropic.com/en/docs/agents-and-tools/tool-use/implement-tool-use#example-of-tool-result-with-images for the format implemented in <a href="https://claudette.answer.ai/core.html#mk_funcres"><code>mk_funcres</code></a>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L356" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="toolresult" class="level3">
<h3 class="anchored" data-anchor-id="toolresult">ToolResult</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ToolResult(</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    result_type:<span class="bu">str</span>, data</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Base class for objects needing a basic <code>__repr__</code></em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L366" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_funcres" class="level3">
<h3 class="anchored" data-anchor-id="mk_funcres">mk_funcres</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_funcres(</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    fc, ns</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Given tool use block ‘fc’, get tool result, and create a tool_result response.</em></p>
<p>We can now use the function requested by Claude. We look it up in <code>ns</code>, and pass in the provided parameters.</p>
<div id="c2e829c2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>fcs <span class="op">=</span> [o <span class="cf">for</span> o <span class="kw">in</span> r.content <span class="cf">if</span> <span class="bu">isinstance</span>(o,ToolUseBlock)]</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>fcs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[ToolUseBlock(id='toolu_01Rk1eL2Zkx92c4c3FJJAjFu', caller=DirectCaller(type='direct'), input={'a': 604542, 'b': 6458932}, name='sums', type='tool_use')]</code></pre>
</div>
</div>
<div id="893f81ca" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> [mk_funcres(fc, ns<span class="op">=</span>ns) <span class="cf">for</span> fc <span class="kw">in</span> fcs]</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>[{'type': 'tool_result',
  'tool_use_id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu',
  'content': 'MySum(val=7063474)'}]</code></pre>
</div>
</div>
<div id="149897bc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> [mk_funcres(fc, ns<span class="op">=</span>{}) <span class="cf">for</span> fc <span class="kw">in</span> fcs]</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'type': 'tool_result',
  'tool_use_id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu',
  'content': 'Error - tool not defined in the tool_schemas: sums'}]</code></pre>
</div>
</div>
</section>
<section id="limit-tool-access" class="level3">
<h3 class="anchored" data-anchor-id="limit-tool-access">Limit tool access</h3>
<div id="02e97a2e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyProd: val:<span class="bu">int</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mults(a:<span class="bu">int</span>,b:<span class="bu">int</span>):</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Multiplies two integers"</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MyProd(a<span class="op">*</span>b)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2eee1b07" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>tools <span class="op">=</span> [get_schema(sums), get_schema(mults)]</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>choice <span class="op">=</span> mk_tool_choice(<span class="st">'sums'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cc4192cb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>tools</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'name': 'sums',
  'description': 'Adds a + b.\n\nReturns:\n- The sum of the inputs (type: integer)',
  'input_schema': {'type': 'object',
   'properties': {'a': {'type': 'integer',
     'description': 'First thing to sum'},
    'b': {'type': 'integer',
     'description': 'Second thing to sum',
     'default': 1}},
   'required': ['a']}},
 {'name': 'mults',
  'description': 'Multiplies two integers',
  'input_schema': {'type': 'object',
   'properties': {'a': {'type': 'integer', 'description': ''},
    'b': {'type': 'integer', 'description': ''}},
   'required': ['a', 'b']}}]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L375" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="allowed_tools" class="level3">
<h3 class="anchored" data-anchor-id="allowed_tools">allowed_tools</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> allowed_tools(</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    specs:Optional, choice:Union<span class="op">=</span><span class="va">None</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="a66bade1" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> allowed_tools(specs: Optional[<span class="bu">list</span>[Union[<span class="bu">str</span>,abc.Callable]]], choice: Optional[Union[<span class="bu">dict</span>,<span class="bu">str</span>]]<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(choice, <span class="bu">dict</span>): choice<span class="op">=</span>mk_tool_choice(choice)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> choice[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'tool'</span>: <span class="cf">return</span> {choice[<span class="st">'name'</span>]}</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> choice[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'none'</span>: <span class="cf">return</span> <span class="bu">set</span>()</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {v[<span class="st">'name'</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(v, <span class="bu">dict</span>) <span class="cf">else</span> v.<span class="va">__name__</span> <span class="cf">for</span> v <span class="kw">in</span> specs <span class="kw">or</span> []}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="d3555159" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>allowed_tools(tools, choice)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'sums'}</code></pre>
</div>
</div>
<div id="be188ef6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>allowed_tools([sums, mults], <span class="st">'mults'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'mults'}</code></pre>
</div>
</div>
<div id="f22e1305" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>allowed_tools(tools, <span class="va">None</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'mults', 'sums'}</code></pre>
</div>
</div>
<div id="8779abe8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>allowed_tools(tools, <span class="st">'sums'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'sums'}</code></pre>
</div>
</div>
<div id="4dd8200b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>allowed_tools(tools, <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'mults', 'sums'}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L382" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="limit_ns" class="level3">
<h3 class="anchored" data-anchor-id="limit_ns">limit_ns</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> limit_ns(</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>    ns:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    specs:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># List of the tools that are allowed for llm to call</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    choice:Union<span class="op">=</span><span class="va">None</span>, <span class="co"># Tool choice as defined by Anthropic API</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Filter namespace <code>ns</code> to only include tools allowed by <code>specs</code> and <code>choice</code></em></p>
<div id="b97a6b1c" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> limit_ns(</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    ns:Optional[abc.Mapping]<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    specs:Optional[<span class="bu">list</span>[Union[<span class="bu">str</span>,abc.Callable]]]<span class="op">=</span><span class="va">None</span>, <span class="co"># List of the tools that are allowed for llm to call</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    choice:Optional[Union[<span class="bu">dict</span>,<span class="bu">str</span>]]<span class="op">=</span><span class="va">None</span> <span class="co"># Tool choice as defined by Anthropic API</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Filter namespace `ns` to only include tools allowed by `specs` and `choice`"</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ns <span class="kw">is</span> <span class="va">None</span>: ns<span class="op">=</span><span class="bu">globals</span>()</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(ns, abc.Mapping): ns <span class="op">=</span> mk_ns(ns)</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    ns <span class="op">=</span> {k:ns[k] <span class="cf">for</span> k <span class="kw">in</span> allowed_tools(specs, choice) <span class="cf">if</span> k <span class="kw">in</span> ns}</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L394" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_toolres" class="level3">
<h3 class="anchored" data-anchor-id="mk_toolres">mk_toolres</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_toolres(</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    r:Mapping, <span class="co"># Tool use request response from Claude</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    ns:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Create a <code>tool_result</code> message from response <code>r</code>.</em></p>
<div id="d475922d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_toolres(</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>    r:abc.Mapping, <span class="co"># Tool use request response from Claude</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    ns:Optional[abc.Mapping]<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create a `tool_result` message from response `r`."</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>    cts <span class="op">=</span> <span class="bu">getattr</span>(r, <span class="st">'content'</span>, [])</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> [mk_msg(r.model_dump(exclude_none<span class="op">=</span><span class="va">True</span>), role<span class="op">=</span><span class="st">'assistant'</span>)]</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ns <span class="kw">is</span> <span class="va">None</span>: ns<span class="op">=</span><span class="bu">globals</span>()</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    tcs <span class="op">=</span> [mk_funcres(o, ns) <span class="cf">for</span> o <span class="kw">in</span> cts <span class="cf">if</span> <span class="bu">isinstance</span>(o,ToolUseBlock)]</span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tcs: res.append(mk_msg(tcs))</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="6940aa6d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>foo <span class="op">=</span> []</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>foo.append({})</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>foo.append({})</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>foo</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{}, {}]</code></pre>
</div>
</div>
<p>In order to tell Claude the result of the tool call, we pass back the tool use assistant request and the <code>tool_result</code> response.</p>
<div id="f13de1fc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, ns<span class="op">=</span>ns)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>tr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'assistant',
  'content': [{'id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu',
    'caller': {'type': 'direct'},
    'input': {'a': 604542, 'b': 6458932},
    'name': 'sums',
    'type': 'tool_use'}]},
 {'role': 'user',
  'content': [{'type': 'tool_result',
    'tool_use_id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu',
    'content': 'MySum(val=7063474)'}]}]</code></pre>
</div>
</div>
<div id="f0fc80e6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'What is 604542+6458932?'}]</code></pre>
</div>
</div>
<p>We add this to our dialog, and now Claude has all the information it needs to answer our question.</p>
<div id="eed99502" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">+=</span> tr</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>contents(c(msgs, sp<span class="op">=</span>sp, tools<span class="op">=</span>tools))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'The sum of 604,542 + 6,458,932 = **7,063,474**.'</code></pre>
</div>
</div>
<div id="8fc252dc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>contents(msgs[<span class="op">-</span><span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'MySum(val=7063474)'</code></pre>
</div>
</div>
<div id="ae64dce3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'What is 604542+6458932?'},
 {'role': 'assistant',
  'content': [{'id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu',
    'caller': {'type': 'direct'},
    'input': {'a': 604542, 'b': 6458932},
    'name': 'sums',
    'type': 'tool_use'}]},
 {'role': 'user',
  'content': [{'type': 'tool_result',
    'tool_use_id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu',
    'content': 'MySum(val=7063474)'}]}]</code></pre>
</div>
</div>
<p>The tools calls are limited to what is present in tool_spec.</p>
<div id="69e4d507" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, ns<span class="op">=</span>limit_ns(<span class="va">None</span>, tools, <span class="st">'mults'</span>))</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>tr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'assistant',
  'content': [{'id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu',
    'caller': {'type': 'direct'},
    'input': {'a': 604542, 'b': 6458932},
    'name': 'sums',
    'type': 'tool_use'}]},
 {'role': 'user',
  'content': [{'type': 'tool_result',
    'tool_use_id': 'toolu_01Rk1eL2Zkx92c4c3FJJAjFu',
    'content': 'Error - tool not defined in the tool_schemas: sums'}]}]</code></pre>
</div>
</div>
</section>
<section id="text-editing" class="level3">
<h3 class="anchored" data-anchor-id="text-editing">Text editing</h3>
<p>Anthropic also has a special tool type specific to text editing.</p>
<div id="6dcc3a92" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>tools <span class="op">=</span> [text_editor_conf[<span class="st">'sonnet'</span>]]</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>tools</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'type': 'text_editor_20250728', 'name': 'str_replace_based_edit_tool'}]</code></pre>
</div>
</div>
<div id="c9a25fc5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">'Could you please very briefly explain my _quarto.yml file?'</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> [mk_msg(pr)]</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(msgs, sp<span class="op">=</span>sp, tools<span class="op">=</span>tools)</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>find_block(r, ToolUseBlock)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>ToolUseBlock(id='toolu_01VuDPR85jDHdSrnCmK52WgL', caller=DirectCaller(type='direct'), input={'command': 'view', 'path': '/_quarto.yml'}, name='str_replace_based_edit_tool', type='tool_use')</code></pre>
</div>
</div>
<p>We’ve gone ahead and create a reference implementation that you can directly use from our <code>text_editor</code> module. Or use as reference for creating your own.</p>
<div id="a056df6c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>ns <span class="op">=</span> mk_ns(str_replace_based_edit_tool)</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, ns<span class="op">=</span>ns)</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">+=</span> tr</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents(c(msgs, sp<span class="op">=</span>sp, tools<span class="op">=</span>tools))[:<span class="dv">128</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>It seems the file wasn't found at the root path. Could you provide the exact location of your `_quarto.yml` file so I can take a</code></pre>
</div>
</div>
</section>
</section>
<section id="structured-data" class="level2">
<h2 class="anchored" data-anchor-id="structured-data">Structured data</h2>
<div id="f326f034" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>a,b <span class="op">=</span> <span class="dv">604542</span>,<span class="dv">6458932</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?"</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"Always use your tools for calculations."</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6dd255e0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tools <span class="kw">in</span> [sums, [get_schema(sums)]]:</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> c(pr, tools<span class="op">=</span>tools, tool_choice<span class="op">=</span><span class="st">'sums'</span>)</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Message(id='msg_01LD3r7hwAkYtWg4XW6A1UaB', container=None, content=[ToolUseBlock(id='toolu_014XCGyV6twGuQxkv8dWGbSc', caller=DirectCaller(type='direct'), input={'a': 604542, 'b': 6458932}, name='sums', type='tool_use')], model='claude-sonnet-4-6', role='assistant', stop_reason='tool_use', stop_sequence=None, type='message', usage=In: 715; Out: 53; Cache create: 0; Cache read: 0; Total Tokens: 768; Search: 0; Fetch: 0)
Message(id='msg_01LD3r7hwAkYtWg4XW6A1UaB', container=None, content=[ToolUseBlock(id='toolu_014XCGyV6twGuQxkv8dWGbSc', caller=DirectCaller(type='direct'), input={'a': 604542, 'b': 6458932}, name='sums', type='tool_use')], model='claude-sonnet-4-6', role='assistant', stop_reason='tool_use', stop_sequence=None, type='message', usage=In: 715; Out: 53; Cache create: 0; Cache read: 0; Total Tokens: 768; Search: 0; Fetch: 0)</code></pre>
</div>
</div>
<div id="f0bb426f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>ns <span class="op">=</span> mk_ns(sums)</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, ns<span class="op">=</span>ns)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L409" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="client.structured" class="level3">
<h3 class="anchored" data-anchor-id="client.structured">Client.structured</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> structured(</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>    msgs:<span class="bu">list</span>, <span class="co"># List of messages in the dialog</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    tools:<span class="bu">list</span><span class="op">=</span><span class="va">None</span>, <span class="co"># List of tools to make available to Claude</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>    ns:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>    sp:<span class="bu">str</span><span class="op">=</span><span class="st">''</span>, <span class="co"># The system prompt</span></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>    temp:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>    maxtok:<span class="bu">int</span><span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>    maxthinktok:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Maximum thinking tokens</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>    prefill:<span class="bu">str</span><span class="op">=</span><span class="st">''</span>, <span class="co"># Optional prefill to pass to Claude as start of its response</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>    stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>    stop:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Stop sequence</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>    tool_choice:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Optionally force use of some tool</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>    cb:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Callback to pass result to when complete</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>    cache_control:Optional[CacheControlEphemeralParam] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>    container:Optional[<span class="bu">str</span>] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>    inference_geo:Optional[<span class="bu">str</span>] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>    metadata:MetadataParam <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>    output_config:OutputConfigParam <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>    service_tier:Literal[<span class="st">'auto'</span>, <span class="st">'standard_only'</span>] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a>    stop_sequences:SequenceNotStr[<span class="bu">str</span>] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a>    system:Union[<span class="bu">str</span>, Iterable[TextBlockParam]] <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a>    temperature:<span class="bu">float</span> <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>    thinking:ThinkingConfigParam <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>    top_k:<span class="bu">int</span> <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a>    top_p:<span class="bu">float</span> <span class="op">|</span> Omit<span class="op">=&lt;</span>anthropic.Omit <span class="bu">object</span> at <span class="bn">0x7fcd6121e210</span><span class="op">&gt;</span>,</span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>    extra_headers:Headers <span class="op">|</span> <span class="va">None</span><span class="op">=</span><span class="va">None</span>, <span class="co"># Use the following arguments if you need to pass additional parameters to the API that aren't available via kwargs.</span></span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a>The extra values given here take precedence over values defined on the client <span class="kw">or</span> passed to this method.</span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a>    extra_query:Query <span class="op">|</span> <span class="va">None</span><span class="op">=</span><span class="va">None</span>, extra_body:Body <span class="op">|</span> <span class="va">None</span><span class="op">=</span><span class="va">None</span>,</span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a>    timeout:<span class="bu">float</span> <span class="op">|</span> httpx.Timeout <span class="op">|</span> <span class="va">None</span> <span class="op">|</span> NotGiven<span class="op">=</span>NOT_GIVEN</span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Return the value of all tool calls (generally used for structured outputs)</em></p>
<div id="b3564424" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(Client.<span class="fu">__call__</span>)</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> structured(<span class="va">self</span>:Client,</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>               msgs:<span class="bu">list</span>, <span class="co"># List of messages in the dialog</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>               tools:<span class="bu">list</span>[abc.Callable]<span class="op">=</span><span class="va">None</span>, <span class="co"># List of tools to make available to Claude</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>               ns:Optional[abc.Mapping]<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>               <span class="op">**</span>kwargs):</span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Return the value of all tool calls (generally used for structured outputs)"</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>    tools <span class="op">=</span> listify(tools)</span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="va">self</span>(msgs, tools<span class="op">=</span>tools, tool_choice<span class="op">=</span>tools, <span class="op">**</span>kwargs)</span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ns <span class="kw">is</span> <span class="va">None</span>: ns<span class="op">=</span>mk_ns(<span class="op">*</span>tools)</span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>    cts <span class="op">=</span> <span class="bu">getattr</span>(res, <span class="st">'content'</span>, [])</span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>    tcs <span class="op">=</span> [call_func(o.name, o.<span class="bu">input</span>, ns<span class="op">=</span>ns) <span class="cf">for</span> o <span class="kw">in</span> cts <span class="cf">if</span> <span class="bu">isinstance</span>(o,ToolUseBlock)]</span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tcs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Anthropic’s API does not support response formats directly, so instead we provide a <code>structured</code> method to use tool calling to achieve the same result. The result of the tool is not passed back to Claude in this case, but instead is returned directly to the user.</p>
<div id="44d2cc82" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>c.structured(pr, tools<span class="op">=</span>[sums])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>[MySum(val=7063474)]</code></pre>
</div>
</div>
<div id="78883bec" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>c</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ToolUseBlock(id=‘toolu_01ENhz5EnfqZFT8PeizJ3gKr’, caller=DirectCaller(type=‘direct’), input={‘a’: 604542, ‘b’: 6458932}, name=‘sums’, type=‘tool_use’)</p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Cost (USD)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input tokens</td>
<td style="text-align: right;">6,400</td>
<td style="text-align: right;">0.019200</td>
</tr>
<tr class="even">
<td>Output tokens</td>
<td style="text-align: right;">499</td>
<td style="text-align: right;">0.007485</td>
</tr>
<tr class="odd">
<td>Cache tokens</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td>Server tool use</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td><strong>Total</strong></td>
<td style="text-align: right;"><strong>6,899</strong></td>
<td style="text-align: right;"><strong>$0.026685</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="custom-types-with-tools-use" class="level2">
<h2 class="anchored" data-anchor-id="custom-types-with-tools-use">Custom Types with Tools Use</h2>
<p>We need to add tool support for custom types too. Let’s test out custom types using a minimal example.</p>
<div id="13d08aba" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Book(BasicRepr):</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, title: <span class="bu">str</span>, pages: <span class="bu">int</span>): store_attr()</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"Book Title : </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>title<span class="sc">}</span><span class="ch">\n</span><span class="ss">Number of Pages : </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>pages<span class="sc">}</span><span class="ss">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="effd7f47" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>Book(<span class="st">"War and Peace"</span>, <span class="dv">950</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Book Title : War and Peace
Number of Pages : 950</code></pre>
</div>
</div>
<div id="465abf5b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_page(book: Book, <span class="co"># The book to find the halfway point of</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>              percent: <span class="bu">int</span>, <span class="co"># Percent of a book to read to, e.g. halfway == 50, </span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"The page number corresponding to `percent` completion of a book"</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">round</span>(book.pages <span class="op">*</span> (percent <span class="op">/</span> <span class="fl">100.0</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="011f74a8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>get_schema(find_page)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'name': 'find_page',
 'description': 'The page number corresponding to `percent` completion of a book\n\nReturns:\n- type: integer',
 'input_schema': {'type': 'object',
  'properties': {'book': {'type': 'object',
    'description': 'The book to find the halfway point of',
    '$ref': '#/$defs/Book'},
   'percent': {'type': 'integer',
    'description': 'Percent of a book to read to, e.g. halfway == 50,'}},
  'required': ['book', 'percent'],
  '$defs': {'Book': {'type': 'object',
    'properties': {'title': {'type': 'string', 'description': ''},
     'pages': {'type': 'integer', 'description': ''}},
    'title': 'Book',
    'required': ['title', 'pages']}}}}</code></pre>
</div>
</div>
<div id="c39dac76" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>choice <span class="op">=</span> mk_tool_choice(<span class="st">'find_page'</span>)</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>choice</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'type': 'tool', 'name': 'find_page'}</code></pre>
</div>
</div>
<p>Claudette will pack objects as dict, so we’ll transform tool functions with user-defined types into tool functions that accept a dict in lieu of the user-defined type.</p>
<p>First let’s convert a single argument:</p>
<p><a href="https://claudette.answer.ai/core.html#_is_builtin"><code>_is_builtin</code></a> decides whether to pass an argument through as-is. Let’s check the argument conversion:</p>
<div id="e6182cae" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>(_is_builtin(<span class="bu">int</span>), _is_builtin(Book), _is_builtin(List))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(True, False, True)</code></pre>
</div>
</div>
<div id="30bcf8cd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>(_convert(<span class="dv">555</span>, <span class="bu">int</span>),</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a> _convert({<span class="st">"title"</span>: <span class="st">"War and Peace"</span>, <span class="st">"pages"</span>: <span class="dv">923</span>}, Book),</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a> _convert([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>], List))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(555,
 Book Title : War and Peace
 Number of Pages : 923,
 [1, 2, 3, 4])</code></pre>
</div>
</div>
<p>To apply <a href="https://claudette.answer.ai/core.html#tool"><code>tool()</code></a> to a function is to return a new function where the user-defined types are replaced with dictionary inputs.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L435" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="tool" class="level3">
<h3 class="anchored" data-anchor-id="tool">tool</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tool(</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    func</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>A function is transformed into a function with dict arguments substituted for user-defined types. Built-in types such as <code>percent</code> here are left untouched.</p>
<div id="dbe72ab6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>find_page(book<span class="op">=</span>Book(<span class="st">"War and Peace"</span>, <span class="dv">950</span>), percent<span class="op">=</span><span class="dv">50</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>475</code></pre>
</div>
</div>
<div id="261f3253" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>tool(find_page)({<span class="st">"title"</span>: <span class="st">"War and Peace"</span>, <span class="st">"pages"</span>: <span class="dv">950</span>}, percent<span class="op">=</span><span class="dv">50</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>475</code></pre>
</div>
</div>
<p>By passing tools wrapped by <a href="https://claudette.answer.ai/core.html#tool"><code>tool()</code></a>, user-defined types now work completes without failing in tool calls.</p>
<div id="48cdcfc2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"How many pages do I have to read to get halfway through my 950 page copy of War and Peace"</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>tools <span class="op">=</span> tool(find_page)</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>tools</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;function __main__.find_page(book: __main__.Book, percent: int) -&gt; int&gt;</code></pre>
</div>
</div>
<div id="848a319e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(pr, tools<span class="op">=</span>[tools])</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>find_block(r, ToolUseBlock)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>ToolUseBlock(id='toolu_01DpqxJGneGatm3JyYr3aNie', caller=DirectCaller(type='direct'), input={'book': {'title': 'War and Peace', 'pages': 950}, 'percent': 50}, name='find_page', type='tool_use')</code></pre>
</div>
</div>
<div id="209fbdf0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, ns<span class="op">=</span>[tools])</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>tr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'assistant',
  'content': [{'text': 'Let me find the halfway point of your book right away!',
    'type': 'text'},
   {'id': 'toolu_01DpqxJGneGatm3JyYr3aNie',
    'caller': {'type': 'direct'},
    'input': {'book': {'title': 'War and Peace', 'pages': 950}, 'percent': 50},
    'name': 'find_page',
    'type': 'tool_use'}]},
 {'role': 'user',
  'content': [{'type': 'tool_result',
    'tool_use_id': 'toolu_01DpqxJGneGatm3JyYr3aNie',
    'content': '475'}]}]</code></pre>
</div>
</div>
<div id="8abdec8a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> [pr]<span class="op">+</span>tr</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>contents(c(msgs, sp<span class="op">=</span>sp, tools<span class="op">=</span>[tools]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>"You'll need to read **475 pages** to get halfway through your 950-page copy of *War and Peace*. You've got quite the reading adventure ahead of you — happy reading! 📖"</code></pre>
</div>
</div>
</section>
</section>
<section id="chat" class="level2">
<h2 class="anchored" data-anchor-id="chat">Chat</h2>
<p>Rather than manually adding the responses to a dialog, we’ll create a simple <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> class to do that for us, each time we make a request. We’ll also store the system prompt and tools here, to avoid passing them every time.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L446" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="chat-1" class="level3">
<h3 class="anchored" data-anchor-id="chat-1">Chat</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Chat(</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>    model:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Model to use (leave empty if passing `cli`)</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    cli:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Client to use (leave empty if passing `model`)</span></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>    sp:<span class="bu">str</span><span class="op">=</span><span class="st">''</span>, <span class="co"># Optional system prompt</span></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>    tools:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># List of tools to make available to Claude</span></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>    temp:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>    cont_pr:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># User prompt to continue an assistant response</span></span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>    cache:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Use Claude cache?</span></span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>    hist:<span class="bu">list</span><span class="op">=</span><span class="va">None</span>, <span class="co"># Initialize history</span></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>    ns:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Anthropic chat client.</em></p>
<p>The class stores the <a href="https://claudette.answer.ai/core.html#client"><code>Client</code></a> that will provide the responses in <code>c</code>, and a history of messages in <code>h</code>.</p>
<div id="04b837c5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"Never mention what tools you use."</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp)</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>chat.c.use, chat.h</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(In: 0; Out: 0; Cache create: 0; Cache read: 0; Total Tokens: 0; Search: 0; Fetch: 0,
 [])</code></pre>
</div>
</div>
<div id="10360d53" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>chat.c.use.cost(pricing[model_types[chat.c.model]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>0.0</code></pre>
</div>
</div>
<p>This is clunky. Let’s add <code>cost</code> as a property for the <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> class. It will pass in the appropriate prices for the current model to the usage cost calculator.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L472" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat.cost" class="level3">
<h3 class="anchored" data-anchor-id="chat.cost">Chat.cost</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">float</span>:</span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="aae25dd2" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(<span class="va">self</span>: Chat) <span class="op">-&gt;</span> <span class="bu">float</span>: <span class="cf">return</span> <span class="va">self</span>.c.cost</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="793d2f2d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>chat.cost</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>0.0</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L492" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat.__call__" class="level3">
<h3 class="anchored" data-anchor-id="chat.__call__">Chat.__call__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>    pr:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Prompt / message</span></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>    temp:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Temperature</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>    maxtok:<span class="bu">int</span><span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>    maxthinktok:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Maximum thinking tokens</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>    stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>    prefill:<span class="bu">str</span><span class="op">=</span><span class="st">''</span>, <span class="co"># Optional prefill to pass to Claude as start of its response</span></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>    tool_choice:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Optionally force use of some tool</span></span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a>    kw:VAR_KEYWORD</span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Call self as a function.</em></p>
<div id="d0178ee1" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _post_pr(<span class="va">self</span>:Chat, pr, prev_role):</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> prev_role <span class="op">==</span> <span class="st">'assistant'</span>:</span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.cont_pr <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Prompt must be given after completion, or use `self.cont_pr`."</span>)</span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>        pr <span class="op">=</span> <span class="va">self</span>.cont_pr <span class="co"># No user prompt, keep the chain</span></span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr: <span class="va">self</span>.h.append(mk_msg(pr, cache<span class="op">=</span><span class="va">self</span>.cache))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="1b5c04e6" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _append_pr(<span class="va">self</span>:Chat, pr<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>    prev_role <span class="op">=</span> nested_idx(<span class="va">self</span>.h, <span class="op">-</span><span class="dv">1</span>, <span class="st">'role'</span>) <span class="cf">if</span> <span class="va">self</span>.h <span class="cf">else</span> <span class="st">'assistant'</span> <span class="co"># First message should be 'user'</span></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr <span class="kw">and</span> prev_role <span class="op">==</span> <span class="st">'user'</span>: <span class="va">self</span>() <span class="co"># already user request pending</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._post_pr(pr, prev_role)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="a9bcc67a" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>:Chat,</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>             pr<span class="op">=</span><span class="va">None</span>,  <span class="co"># Prompt / message</span></span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>             temp<span class="op">=</span><span class="va">None</span>, <span class="co"># Temperature</span></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>             maxtok<span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>             maxthinktok<span class="op">=</span><span class="dv">0</span>, <span class="co"># Maximum thinking tokens</span></span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>             stream<span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>             prefill<span class="op">=</span><span class="st">''</span>, <span class="co"># Optional prefill to pass to Claude as start of its response</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a>             tool_choice:Optional[<span class="bu">dict</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># Optionally force use of some tool</span></span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>             <span class="op">**</span>kw):</span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> temp <span class="kw">is</span> <span class="va">None</span>: temp<span class="op">=</span><span class="va">self</span>.temp</span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._append_pr(pr)</span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _cb(v):</span>
<span id="cb212-14"><a href="#cb212-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.last <span class="op">=</span> mk_toolres(v, ns<span class="op">=</span>limit_ns(<span class="va">self</span>.ns, <span class="va">self</span>.tools, tool_choice))</span>
<span id="cb212-15"><a href="#cb212-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.h <span class="op">+=</span> <span class="va">self</span>.last</span>
<span id="cb212-16"><a href="#cb212-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.c(<span class="va">self</span>.h, stream<span class="op">=</span>stream, prefill<span class="op">=</span>prefill, sp<span class="op">=</span><span class="va">self</span>.sp, temp<span class="op">=</span>temp, maxtok<span class="op">=</span>maxtok, maxthinktok<span class="op">=</span>maxthinktok,</span>
<span id="cb212-17"><a href="#cb212-17" aria-hidden="true" tabindex="-1"></a>                 tools<span class="op">=</span><span class="va">self</span>.tools, tool_choice<span class="op">=</span>tool_choice, cb<span class="op">=</span>_cb, <span class="op">**</span>kw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The <code>__call__</code> method just passes the request along to the <a href="https://claudette.answer.ai/core.html#client"><code>Client</code></a>, but rather than just passing in this one prompt, it appends it to the history and passes it all along. As a result, we now have state!</p>
<div id="cb393257" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="40073f42" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"I'm Jeremy"</span>)</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"What's my name?"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Jeremy! You told me that at the start of our conversation.</p>
<details>
<ul>
<li>id: <code>msg_01P1dvBtCrRx33Z6FSzcoaYT</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Your name is Jeremy! You told me that at the start of our conversation.', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 44, 'output_tokens': 19, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="5457b51d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>chat.use, chat.cost</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(In: 62; Out: 37; Cache create: 0; Cache read: 0; Total Tokens: 99; Search: 0; Fetch: 0,
 0.000741)</code></pre>
</div>
</div>
<p>By default messages must be in user, assistant, user format. If this isn’t followed (aka calling <code>chat()</code> without a user message) it will error out:</p>
<div id="c3761928" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: chat()</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e: <span class="bu">print</span>(<span class="st">"Error:"</span>, e)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error: Prompt must be given after completion, or use `self.cont_pr`.</code></pre>
</div>
</div>
<p>Setting <code>cont_pr</code> allows a “default prompt” to be specified when a prompt isn’t specified. Usually used to prompt the model to continue.</p>
<div id="54c5a2bc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>chat.cont_pr <span class="op">=</span> <span class="st">"Tell me a little more..."</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>chat()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>That’s actually all I know about you! You just told me your name is Jeremy, but beyond that, I don’t have any other information about you. I only know what you share with me in our conversation.</p>
<p>Is there something you’d like to tell me about yourself, or is there something I can help you with? 😊</p>
<details>
<ul>
<li>id: <code>msg_014GNbvuJySM2FNydyTvHnZ6</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': "That's actually all I know about you! You just told me your name is Jeremy, but beyond that, I don't have any other information about you. I only know what you share with me in our conversation.\n\nIs there something you'd like to tell me about yourself, or is there something I can help you with? 😊", 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 72, 'output_tokens': 73, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>We can also use streaming:</p>
<div id="529104ec" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp)</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> chat(<span class="st">"I'm Jeremy"</span>, stream<span class="op">=</span><span class="va">True</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hi Jeremy! Nice to meet you. How can I help you today?</code></pre>
</div>
</div>
<p>You can provide a history of messages to initialise <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> with:</p>
<div id="32814e78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp, hist<span class="op">=</span>[<span class="st">"Can you guess my name?"</span>, <span class="st">"Hmmm I really don't know. Is it 'Merlin G. Penfolds'?"</span>])</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">'Wow how did you know?'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I have to be honest with you - I didn’t actually know! That was just a random guess, and it was quite a coincidence that it matched your name! I have no way of knowing personal information about you unless you share it with me. I should have been upfront about that from the start rather than making a random guess. I’m sorry for any confusion!</p>
<details>
<ul>
<li>id: <code>msg_01RmtMSvQpWsDNdTgZdRpKXb</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': "I have to be honest with you - I didn't actually know! That was just a random guess, and it was quite a coincidence that it matched your name! I have no way of knowing personal information about you unless you share it with me. I should have been upfront about that from the start rather than making a random guess. I'm sorry for any confusion!", 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 59, 'output_tokens': 79, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="chat-tool-use" class="level3">
<h3 class="anchored" data-anchor-id="chat-tool-use">Chat tool use</h3>
<p>We automagically get streamlined tool use as well:</p>
<div id="ee6535cf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?"</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>pr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'What is 604542+6458932?'</code></pre>
</div>
</div>
<div id="797741c5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp, tools<span class="op">=</span>[sums])</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(pr)</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Let me calculate that for you!</p>
<details>
<ul>
<li>id: <code>msg_01J64NLNAmMicFA6nhmuT6pM</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Let me calculate that for you!', 'type': 'text'}, {'id': 'toolu_017rP1c4tyoBaMyDT2pjRMcH', 'caller': {'type': 'direct'}, 'input': {'a': 604542, 'b': 6458932}, 'name': 'sums', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 627, 'output_tokens': 80, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>Now we need to send this result to Claude—calling the object with no parameters tells it to return the tool result to Claude:</p>
<div id="b091eae0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>chat()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The result of <strong>604,542 + 6,458,932 = 7,063,474</strong>!</p>
<details>
<ul>
<li>id: <code>msg_013HLnrJxLLM165PKGnnHBmJ</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'The result of **604,542 + 6,458,932 = 7,063,474**!', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 727, 'output_tokens': 28, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>It should be correct, because it actually used our Python function to do the addition. Let’s check:</p>
<div id="06bfbf3d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>a<span class="op">+</span>b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>7063474</code></pre>
</div>
</div>
<p>Let’s try the same thing with streaming:</p>
<div id="4f141888" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp, tools<span class="op">=</span>[sums])</span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(pr, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r: <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Let me calculate that for you!Finding the sum of 604542 and 6458932</code></pre>
</div>
</div>
<p>The full message, including tool call details, are in <code>value</code>:</p>
<div id="bfc0d5d7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>r.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Let me calculate that for you!</p>
<details>
<ul>
<li>id: <code>msg_01CthQaWS7F2MTeQjHPtKwVS</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Let me calculate that for you!', 'type': 'text', 'parsed_output': None}, {'id': 'toolu_01E9JqVMwnUSrEGwfYsegP63', 'caller': {'type': 'direct'}, 'input': {'a': 604542, 'b': 6458932}, 'name': 'sums', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 627, 'output_tokens': 80, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="bdbfdea5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r: <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>The result of **604,542 + 6,458,932 = 7,063,474**!</code></pre>
</div>
</div>
<div id="c208c90e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>r.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The result of <strong>604,542 + 6,458,932 = 7,063,474</strong>!</p>
<details>
<ul>
<li>id: <code>msg_01KDCwZXa6fbqy9WLXwYq9gY</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'The result of **604,542 + 6,458,932 = 7,063,474**!', 'type': 'text', 'parsed_output': None}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 727, 'output_tokens': 28, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>The history shows both the tool_use and tool_result messages:</p>
<div id="15860ba0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>chat.h</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'What is 604542+6458932?'},
 {'role': 'assistant',
  'content': [{'text': 'Let me calculate that for you!', 'type': 'text'},
   {'id': 'toolu_01E9JqVMwnUSrEGwfYsegP63',
    'caller': {'type': 'direct'},
    'input': {'a': 604542, 'b': 6458932},
    'name': 'sums',
    'type': 'tool_use'}]},
 {'role': 'user',
  'content': [{'type': 'tool_result',
    'tool_use_id': 'toolu_01E9JqVMwnUSrEGwfYsegP63',
    'content': 'MySum(val=7063474)'}]},
 {'role': 'assistant',
  'content': [{'text': 'The result of **604,542 + 6,458,932 = 7,063,474**!',
    'type': 'text'}]}]</code></pre>
</div>
</div>
<p>The <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> class automatically validates tool calls against the provided <code>tools</code> list. If the model attempts to call a tool that isn’t in the allowed set (whether due to hallucination or a mismatch between <code>tools</code> and <code>ns</code>), the tool call will fail with an error message rather than executing arbitrary code.</p>
<p>This provides an important safety mechanism - even if the model invents a function name or tries to call a tool that shouldn’t be available, <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> ensures only explicitly allowed tools can be executed.</p>
<div id="00ec5d56" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _force_sums(<span class="op">*</span>args, cb<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs): </span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cb_(r): </span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> r.content:</span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(block, ToolUseBlock): block.name <span class="op">=</span> <span class="ss">f'sums'</span> <span class="co"># Forces tool name to 'sums'</span></span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cb(r) <span class="cf">if</span> cb <span class="cf">else</span> r</span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Client(model)(<span class="op">*</span>args, cb<span class="op">=</span>cb_, <span class="op">**</span>kwargs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="29c48acc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(cli<span class="op">=</span>_force_sums, sp<span class="op">=</span>sp, tools<span class="op">=</span>[mults]) <span class="co"># Only 'mults' is allowed</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>chat.ns <span class="op">=</span> [mults, sums] <span class="co"># Both function exist in namespace</span></span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="st">"Calc 604542 * 33392837120239382"</span>)</span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I need to multiply these two large numbers. Let me break this down into smaller multiplications and combine the results.</p>
<p>I’ll express <strong>33392837120239382</strong> in parts: - 33392837120239382 = 3339283712 * 10⁷ + 239382 * 10⁰ (wait, let me be more precise) - 33392837120239382 = <strong>33392837120</strong> * 10⁶ + <strong>239382</strong></p>
<p>And I’ll compute: - <strong>604542 * 33392837120</strong> and <strong>604542 * 239382</strong> separately.</p>
<p>Further breaking down: - 33392837120 = <strong>3339283</strong> * 10⁴ + <strong>7120</strong> - So: 604542 * 33392837120 = (604542 * 3339283) * 10⁴ + (604542 * 7120)</p>
<p>And 3339283 = <strong>3339</strong> * 10³ + <strong>283</strong> - So: 604542 * 3339283 = (604542 * 3339) * 10³ + (604542 * 283)</p>
<p>Let me fire all the independent multiplications simultaneously!</p>
<details>
<ul>
<li>id: <code>msg_01MGBGG5gTd6y1NbvS3fu5SU</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': "I need to multiply these two large numbers. Let me break this down into smaller multiplications and combine the results.\n\nI'll express **33392837120239382** in parts:\n- 33392837120239382 = 3339283712 * 10⁷ + 239382 * 10⁰ (wait, let me be more precise)\n- 33392837120239382 = **33392837120** * 10⁶ + **239382**\n\nAnd I'll compute:\n- **604542 * 33392837120** and **604542 * 239382** separately.\n\nFurther breaking down:\n- 33392837120 = **3339283** * 10⁴ + **7120**\n- So: 604542 * 33392837120 = (604542 * 3339283) * 10⁴ + (604542 * 7120)\n\nAnd 3339283 = **3339** * 10³ + **283**\n- So: 604542 * 3339283 = (604542 * 3339) * 10³ + (604542 * 283)\n\nLet me fire all the independent multiplications simultaneously!", 'type': 'text'}, {'id': 'toolu_01PTTnLJSNpmoYTC9EADnJC9', 'caller': {'type': 'direct'}, 'input': {'a': 604542, 'b': 3339}, 'name': 'sums', 'type': 'tool_use'}, {'id': 'toolu_011gQv4XAQcpCnQahMccsR15', 'caller': {'type': 'direct'}, 'input': {'a': 604542, 'b': 283}, 'name': 'sums', 'type': 'tool_use'}, {'id': 'toolu_01Fx8aFaN99yDMxhFJ8RuCFW', 'caller': {'type': 'direct'}, 'input': {'a': 604542, 'b': 7120}, 'name': 'sums', 'type': 'tool_use'}, {'id': 'toolu_01HRnSCYyrz8Kdwz4YJ1aAuN', 'caller': {'type': 'direct'}, 'input': {'a': 604542, 'b': 239382}, 'name': 'sums', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 599, 'output_tokens': 520, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="6ae42fd4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>chat.h</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Calc 604542 * 33392837120239382'},
 {'role': 'assistant',
  'content': [{'text': "I need to multiply these two large numbers. Let me break this down into smaller multiplications and combine the results.\n\nI'll express **33392837120239382** in parts:\n- 33392837120239382 = 3339283712 * 10⁷ + 239382 * 10⁰ (wait, let me be more precise)\n- 33392837120239382 = **33392837120** * 10⁶ + **239382**\n\nAnd I'll compute:\n- **604542 * 33392837120** and **604542 * 239382** separately.\n\nFurther breaking down:\n- 33392837120 = **3339283** * 10⁴ + **7120**\n- So: 604542 * 33392837120 = (604542 * 3339283) * 10⁴ + (604542 * 7120)\n\nAnd 3339283 = **3339** * 10³ + **283**\n- So: 604542 * 3339283 = (604542 * 3339) * 10³ + (604542 * 283)\n\nLet me fire all the independent multiplications simultaneously!",
    'type': 'text'},
   {'id': 'toolu_01PTTnLJSNpmoYTC9EADnJC9',
    'caller': {'type': 'direct'},
    'input': {'a': 604542, 'b': 3339},
    'name': 'sums',
    'type': 'tool_use'},
   {'id': 'toolu_011gQv4XAQcpCnQahMccsR15',
    'caller': {'type': 'direct'},
    'input': {'a': 604542, 'b': 283},
    'name': 'sums',
    'type': 'tool_use'},
   {'id': 'toolu_01Fx8aFaN99yDMxhFJ8RuCFW',
    'caller': {'type': 'direct'},
    'input': {'a': 604542, 'b': 7120},
    'name': 'sums',
    'type': 'tool_use'},
   {'id': 'toolu_01HRnSCYyrz8Kdwz4YJ1aAuN',
    'caller': {'type': 'direct'},
    'input': {'a': 604542, 'b': 239382},
    'name': 'sums',
    'type': 'tool_use'}]},
 {'role': 'user',
  'content': [{'type': 'tool_result',
    'tool_use_id': 'toolu_01PTTnLJSNpmoYTC9EADnJC9',
    'content': 'Error - tool not defined in the tool_schemas: sums'},
   {'type': 'tool_result',
    'tool_use_id': 'toolu_011gQv4XAQcpCnQahMccsR15',
    'content': 'Error - tool not defined in the tool_schemas: sums'},
   {'type': 'tool_result',
    'tool_use_id': 'toolu_01Fx8aFaN99yDMxhFJ8RuCFW',
    'content': 'Error - tool not defined in the tool_schemas: sums'},
   {'type': 'tool_result',
    'tool_use_id': 'toolu_01HRnSCYyrz8Kdwz4YJ1aAuN',
    'content': 'Error - tool not defined in the tool_schemas: sums'}]}]</code></pre>
</div>
</div>
<p>Let’s test a function with user defined types.</p>
<div id="d4db78d9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp, tools<span class="op">=</span>[find_page])</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="st">"How many pages is three quarters of the way through my 80 page edition of Tao Te Ching?"</span>)</span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ToolUseBlock(id=‘toolu_01G77V2RMBcxVDKqsCYmZ9Au’, caller=DirectCaller(type=‘direct’), input={‘book’: {‘title’: ‘Tao Te Ching’, ‘pages’: 80}, ‘percent’: 75}, name=‘find_page’, type=‘tool_use’)</p>
<details>
<ul>
<li>id: <code>msg_01Uzs8htuGbvrC1Nq1skRD8t</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'id': 'toolu_01G77V2RMBcxVDKqsCYmZ9Au', 'caller': {'type': 'direct'}, 'input': {'book': {'title': 'Tao Te Ching', 'pages': 80}, 'percent': 75}, 'name': 'find_page', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 731, 'output_tokens': 87, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="0979c832" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>chat()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Three quarters of the way through your 80-page edition of the Tao Te Ching is <strong>page 60</strong>!</p>
<details>
<ul>
<li>id: <code>msg_017zd57Uf73R262oY6F1T9ia</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Three quarters of the way through your 80-page edition of the Tao Te Ching is **page 60**!', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 831, 'output_tokens': 31, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="49c3a35a" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _repr_markdown_(<span class="va">self</span>:Chat):</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.c, <span class="st">'result'</span>): <span class="cf">return</span> <span class="st">'No results yet'</span></span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>    last_msg <span class="op">=</span> contents(<span class="va">self</span>.c.result)</span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fmt_msg(m):</span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> contents(m)</span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(t, <span class="bu">dict</span>): <span class="cf">return</span> t[<span class="st">'content'</span>]</span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> t</span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(<span class="ss">f"**</span><span class="sc">{</span>m[<span class="st">'role'</span>]<span class="sc">}</span><span class="ss">**: </span><span class="sc">{</span>fmt_msg(m)<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb244-12"><a href="#cb244-12" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">for</span> m <span class="kw">in</span> <span class="va">self</span>.h)</span>
<span id="cb244-13"><a href="#cb244-13" aria-hidden="true" tabindex="-1"></a>    det <span class="op">=</span> <span class="va">self</span>.c._repr_markdown_().split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb244-14"><a href="#cb244-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> history: history <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb244-15"><a href="#cb244-15" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;details&gt;</span></span>
<span id="cb244-16"><a href="#cb244-16" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;summary&gt;► History&lt;/summary&gt;</span></span>
<span id="cb244-17"><a href="#cb244-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-18"><a href="#cb244-18" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>history<span class="sc">}</span></span>
<span id="cb244-19"><a href="#cb244-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-20"><a href="#cb244-20" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;/details&gt;</span></span>
<span id="cb244-21"><a href="#cb244-21" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb244-22"><a href="#cb244-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-23"><a href="#cb244-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span><span class="sc">{</span>last_msg<span class="sc">}</span></span>
<span id="cb244-24"><a href="#cb244-24" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>history<span class="sc">}</span></span>
<span id="cb244-25"><a href="#cb244-25" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>det<span class="sc">}</span><span class="ss">"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="2baedd52" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>chat</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Three quarters of the way through your 80-page edition of the Tao Te Ching is <strong>page 60</strong>!</p>
<details>
<summary>
► History
</summary>
<p><strong>user</strong>: H</p>
<p><strong>assistant</strong>: {‘id’: ‘toolu_01G77V2RMBcxVDKqsCYmZ9Au’, ‘caller’: {‘type’: ‘direct’}, ‘input’: {‘book’: {‘title’: ‘Tao Te Ching’, ‘pages’: 80}, ‘percent’: 75}, ‘name’: ‘find_page’, ‘type’: ‘tool_use’}</p>
<p><strong>user</strong>: 60</p>
<p><strong>assistant</strong>: Three quarters of the way through your 80-page edition of the Tao Te Ching is <strong>page 60</strong>!</p>
</details>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Cost (USD)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input tokens</td>
<td style="text-align: right;">1,562</td>
<td style="text-align: right;">0.004686</td>
</tr>
<tr class="even">
<td>Output tokens</td>
<td style="text-align: right;">118</td>
<td style="text-align: right;">0.001770</td>
</tr>
<tr class="odd">
<td>Cache tokens</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td>Server tool use</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td><strong>Total</strong></td>
<td style="text-align: right;"><strong>1,680</strong></td>
<td style="text-align: right;"><strong>$0.006456</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="c76a22fb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, tools<span class="op">=</span>[text_editor_conf[<span class="st">'sonnet'</span>]], ns<span class="op">=</span>mk_ns(str_replace_based_edit_tool))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>When not providing tools directly as Python functions (like <code>sum</code>), you <strong>must</strong> create and pass a namespace dictionary (mapping the tool name string to the function object) using the <code>ns</code> parameter to methods like <a href="https://claudette.answer.ai/core.html#mk_toolres"><code>mk_toolres</code></a> or <code>toolloop</code>. <code>toolslm</code> cannot automatically generate the namespace in this case. For schema-based tools (i.e., Python functions), <code>claudette</code> handles namespace creation automatically.</p>
<div id="ebbd0cd2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="st">'Please explain very concisely what my _quarto.yml does. It is in the current path. Use your tools'</span>)</span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>find_block(r, ToolUseBlock)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>ToolUseBlock(id='toolu_01SGFXBDAd9ykwQ8fnpVApWu', caller=DirectCaller(type='direct'), input={'command': 'view', 'path': '/_quarto.yml'}, name='str_replace_based_edit_tool', type='tool_use')</code></pre>
</div>
</div>
<div id="0b7717a8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>chat()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ToolUseBlock(id=‘toolu_01VJcCojtvzkaSjENnFACwn5’, caller=DirectCaller(type=‘direct’), input={‘command’: ‘view’, ‘path’: ‘.’}, name=‘str_replace_based_edit_tool’, type=‘tool_use’)</p>
<details>
<ul>
<li>id: <code>msg_01LED9Xieob4miFXjXouNTue</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'id': 'toolu_01VJcCojtvzkaSjENnFACwn5', 'caller': {'type': 'direct'}, 'input': {'command': 'view', 'path': '.'}, 'name': 'str_replace_based_edit_tool', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 1379, 'output_tokens': 75, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="images" class="level2">
<h2 class="anchored" data-anchor-id="images">Images</h2>
<p>Claude can handle image data as well. As everyone knows, when testing image APIs you have to use a cute puppy.</p>
<div id="5d35d564" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Image is Cute_dog.jpg from Wikimedia</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>fn <span class="op">=</span> Path(<span class="st">'samples/puppy.jpg'</span>)</span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>Image(filename<span class="op">=</span>fn, width<span class="op">=</span><span class="dv">200</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-175-output-1.jpeg" class="img-fluid figure-img" width="200"></p>
</figure>
</div>
</div>
</div>
<div id="d120d8fb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> fn.read_bytes()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Claude expects an image message to have the following structure</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb252"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'role'</span><span class="op">:</span> <span class="st">'user'</span><span class="op">,</span> </span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'content'</span><span class="op">:</span> [</span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'type'</span><span class="op">:</span><span class="st">'text'</span><span class="op">,</span> <span class="st">'text'</span><span class="op">:</span><span class="st">'What is in the image?'</span>}<span class="op">,</span></span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">'type'</span><span class="op">:</span><span class="st">'image'</span><span class="op">,</span> </span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">'source'</span><span class="op">:</span> {</span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">'type'</span><span class="op">:</span><span class="st">'base64'</span><span class="op">,</span> <span class="st">'media_type'</span><span class="op">:</span><span class="st">'media_type'</span><span class="op">,</span> <span class="st">'data'</span><span class="op">:</span> <span class="st">'data'</span></span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>msglm</code> automatically detects if a message is an image, encodes it, and generates the data structure above. All we need to do is a create a list containing our image and a query and then pass it to <code>mk_msg</code>.</p>
<p>Let’s try it out…</p>
<div id="db8339ac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb253"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> <span class="st">"In brief, what color flowers are in this image?"</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([img, q])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="69acc8c7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>c([msg])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The flowers in the image are <strong>purple/lavender</strong> (blue-purple). They appear to be <strong>asters</strong>.</p>
<details>
<ul>
<li>id: <code>msg_01DUds87tAj47fozgFfbEPrQ</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'The flowers in the image are **purple/lavender** (blue-purple). They appear to be **asters**.', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 110, 'output_tokens': 28, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>You don’t need to call <code>mk_msg</code> on each individual message before passing them to the <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> class. Instead you can pass your messages in a list and the <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> class will automatically call <code>mk_msgs</code> in the background.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>c([<span class="st">"How are you?"</span>, r])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>For messages that contain multiple content types (like an image with a question), you’ll need to enclose the message contents in a list as shown below:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>c([<span class="st">"How are you?"</span>, r, [img, q]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="73ce3789" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model)</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>c([img, q])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The flowers in the image are <strong>purple/lavender</strong> (blue-purple). They appear to be <strong>asters</strong>.</p>
<details>
<ul>
<li>id: <code>msg_01DUds87tAj47fozgFfbEPrQ</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'The flowers in the image are **purple/lavender** (blue-purple). They appear to be **asters**.', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 110, 'output_tokens': 28, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="8b9d8064" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>contents(c.h[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'*Media Type - image*'</code></pre>
</div>
</div>
<div id="3eb5f016" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>c</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The flowers in the image are <strong>purple/lavender</strong> (blue-purple). They appear to be <strong>asters</strong>.</p>
<details>
<summary>
► History
</summary>
<p><strong>user</strong>: <em>Media Type - image</em></p>
<p><strong>assistant</strong>: The flowers in the image are <strong>purple/lavender</strong> (blue-purple). They appear to be <strong>asters</strong>.</p>
</details>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Cost (USD)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input tokens</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">0.000330</td>
</tr>
<tr class="even">
<td>Output tokens</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">0.000420</td>
</tr>
<tr class="odd">
<td>Cache tokens</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td>Server tool use</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td><strong>Total</strong></td>
<td style="text-align: right;"><strong>138</strong></td>
<td style="text-align: right;"><strong>$0.000750</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Unfortunately, not all Claude models support images 😞. This <a href="https://docs.anthropic.com/en/docs/about-claude/models#model-comparison-table">table</a> summarizes the capabilities of each Claude model and the different modalities they support.</p>
</div>
</div>
</section>
<section id="caching" class="level2">
<h2 class="anchored" data-anchor-id="caching">Caching</h2>
<p>Claude supports context caching by adding a <code>cache_control</code> header to the message content.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb261"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"role"</span><span class="op">:</span> <span class="st">"user"</span><span class="op">,</span></span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"content"</span><span class="op">:</span> [</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span> </span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"text"</span><span class="op">:</span> <span class="st">"Please cache my message"</span><span class="op">,</span> </span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cache_control"</span><span class="op">:</span> {<span class="st">"type"</span><span class="op">:</span> <span class="st">"ephemeral"</span>}</span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb261-9"><a href="#cb261-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb261-10"><a href="#cb261-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>To cache a message, we simply set <code>cache=True</code> when calling <code>mk_msg</code>.</p>
<div id="19a9d3e1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb262"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>mk_msg([<span class="st">'hi'</span>, <span class="st">'there'</span>], cache<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>{ <span class="st">'content'</span>: [ {<span class="st">'text'</span>: <span class="st">'hi'</span>, <span class="st">'type'</span>: <span class="st">'text'</span>},</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>               { <span class="st">'cache_control'</span>: {<span class="st">'type'</span>: <span class="st">'ephemeral'</span>},</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'text'</span>: <span class="st">'there'</span>,</span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'type'</span>: <span class="st">'text'</span>}],</span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'role'</span>: <span class="st">'user'</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>Claude also now supports smart cache look-ups, so it’s very simple to keep an entire conversation in cache by constantly telling it to update the cache with the latest message. To do this, we just need to set <code>cache=True</code> when creating a <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a>.</p>
<div id="5eb7bed0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp, cache<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Caching has a minimum token limit of 1024 tokens for Sonnet and Opus, and 2048 for Haiku. If your conversation is below this limit, it will not be cached.</p>
<div id="ed6e5fe2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Hi, I'm Jeremy."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Jeremy! Nice to meet you. How are you doing today? Is there something I can help you with?</p>
<details>
<ul>
<li>id: <code>msg_01WQUgAZDsjnFgUd4tzxLJHN</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Hi Jeremy! Nice to meet you. How are you doing today? Is there something I can help you with?', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 21, 'output_tokens': 26, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="51fc2c82" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>chat.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 21; Out: 26; Cache create: 0; Cache read: 0; Total Tokens: 47; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<p>Note the usage: no cache is created, nor used. Now, let’s send a long enough message to trigger caching.</p>
<div id="e870355c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"""Lorem ipsum dolor sit amet"""</span> <span class="op">*</span> <span class="dv">150</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>It looks like you’ve sent a large block of repeated “Lorem ipsum dolor sit amet” placeholder text. This is commonly used in design and publishing as dummy text.</p>
<p>Was this sent by accident, or is there something specific you’d like help with, Jeremy? 😊</p>
<details>
<ul>
<li>id: <code>msg_0164VgWyvwHC2HAGrzFJUbDB</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'It looks like you\'ve sent a large block of repeated "Lorem ipsum dolor sit amet" placeholder text. This is commonly used in design and publishing as dummy text.\n\nWas this sent by accident, or is there something specific you\'d like help with, Jeremy? 😊', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 1098, 'output_tokens': 59, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="f79eeb82" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>chat.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 1119; Out: 85; Cache create: 0; Cache read: 0; Total Tokens: 1204; Search: 0; Fetch: 0</code></pre>
</div>
</div>
<p>The context is now long enough for cache to be used. All the conversation history has now been written to the temporary cache. Any subsequent message will read from it rather than re-processing the entire conversation history.</p>
<div id="1dc2286e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Oh thank you! Sorry, my lorem ipsum generator got out of control!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Ha, no worries at all, Jeremy! Those lorem ipsum generators can definitely get a little wild sometimes! 😄 It happens to the best of us. Is there something I can actually help you with today?</p>
<details>
<ul>
<li>id: <code>msg_01FeLGZ2T49tUHaWKaQAJAhn</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': 'Ha, no worries at all, Jeremy! Those lorem ipsum generators can definitely get a little wild sometimes! 😄 It happens to the best of us. Is there something I can actually help you with today?', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 1175, 'output_tokens': 48, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<div id="18f86124" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>chat.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>In: 2294; Out: 133; Cache create: 0; Cache read: 0; Total Tokens: 2427; Search: 0; Fetch: 0</code></pre>
</div>
</div>
</section>
<section id="extended-thinking" class="level2">
<h2 class="anchored" data-anchor-id="extended-thinking">Extended Thinking</h2>
<p>Claude &gt;=3.7 have enhanced reasoning capabilities for complex tasks. See <a href="https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking">docs</a> for more info.</p>
<p>We can enable extended thinking by passing a <code>thinking</code> param with the following structure.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb274"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>thinking<span class="op">=</span>{ <span class="st">"type"</span><span class="op">:</span> <span class="st">"enabled"</span><span class="op">,</span> <span class="st">"budget_tokens"</span><span class="op">:</span> <span class="dv">16000</span> }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>When extended thinking is enabled a thinking block is included in the response as shown below.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb275"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"content"</span><span class="op">:</span> [</span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"type"</span><span class="op">:</span> <span class="st">"thinking"</span><span class="op">,</span></span>
<span id="cb275-5"><a href="#cb275-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"thinking"</span><span class="op">:</span> <span class="st">"To approach this, let's think about..."</span><span class="op">,</span></span>
<span id="cb275-6"><a href="#cb275-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">"signature"</span><span class="op">:</span> <span class="st">"Imtakcjsu38219c0.eyJoYXNoIjoiYWJjM0NTY3fQ...."</span></span>
<span id="cb275-7"><a href="#cb275-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb275-8"><a href="#cb275-8" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb275-9"><a href="#cb275-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span></span>
<span id="cb275-10"><a href="#cb275-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"text"</span><span class="op">:</span> <span class="st">"Yes, there are infinitely many prime numbers such that..."</span></span>
<span id="cb275-11"><a href="#cb275-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb275-12"><a href="#cb275-12" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb275-13"><a href="#cb275-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Note: When thinking is <a href="https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking#important-considerations-when-using-extended-thinking">enabled</a> <code>prefill</code> must be empty and the <code>temp</code> must be 1.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L537" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="think_md" class="level3">
<h3 class="anchored" data-anchor-id="think_md">think_md</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb276"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> think_md(</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>    txt, thk</span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="02b8ad04" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb277"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contents(r, show_thk<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to get the contents from Claude response `r`."</span></span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>    blk <span class="op">=</span> find_block(r)</span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_thk:</span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>        tk_blk <span class="op">=</span> find_block(r, blk_type<span class="op">=</span>ThinkingBlock)</span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tk_blk: <span class="cf">return</span> think_md(blk.text.strip(), tk_blk.thinking.strip())</span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> blk <span class="kw">and</span> r.content: blk <span class="op">=</span> r.content[<span class="dv">0</span>]</span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(blk,<span class="st">'text'</span>): <span class="cf">return</span> blk.text.strip()</span>
<span id="cb277-9"><a href="#cb277-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(blk,<span class="st">'content'</span>): <span class="cf">return</span> blk.content.strip()</span>
<span id="cb277-10"><a href="#cb277-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(blk,<span class="st">'source'</span>): <span class="cf">return</span> <span class="ss">f'*Media Type - </span><span class="sc">{</span>blk<span class="sc">.</span><span class="bu">type</span><span class="sc">}</span><span class="ss">*'</span></span>
<span id="cb277-11"><a href="#cb277-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">str</span>(blk)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s call the model without extended thinking enabled.</p>
<div id="adc3e86f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b7911771" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb279"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Write a sentence about Python!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Here’s a sentence about Python:</p>
<p><strong>Python is a versatile, beginner-friendly programming language known for its clean, readable syntax and wide range of applications, from web development and data science to artificial intelligence and automation.</strong></p>
<p>Would you like to know more about Python? 🐍</p>
<details>
<ul>
<li>id: <code>msg_0133ueaeXR2KvELPiPDnpFAC</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': None, 'text': "Here's a sentence about Python:\n\n**Python is a versatile, beginner-friendly programming language known for its clean, readable syntax and wide range of applications, from web development and data science to artificial intelligence and automation.**\n\nWould you like to know more about Python? 🐍", 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 13, 'output_tokens': 63, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>Now, let’s call the model with extended thinking enabled.</p>
<div id="be225c95" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Write a sentence about Python!"</span>, maxthinktok<span class="op">=</span><span class="dv">1024</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Here’s a sentence about Python:</p>
<p><strong>Python is one of the most popular programming languages in the world, loved by developers for its simplicity, powerful libraries, and ability to handle complex tasks with just a few lines of code.</strong></p>
<p>Fun fact: Python was named after the British comedy group <strong>Monty Python</strong>, not the snake! 🐍😄</p>
<p>Would you like to learn more about Python?</p>
<details>
<summary>
Thinking
</summary>
The user wants another sentence about Python. Let me write a different one this time.
</details>
<details>
<ul>
<li>id: <code>msg_01Vuqd8xUwuB2tTnmcexcfFp</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'signature': 'Ev0BCkYICxgCKkAmUcWkc6z1j9s2pIRVL/EIaNbJYCaXR1stNeEAhQoCylzrssuUy2ZTq4vGWUl7WbH2AbV30H8aRazSNGwgnQp+Egzq7GmzjPUY/hkdH1oaDKbN8/A53z7nu/TenyIwIAhQomWRMzdCY7ueYlSChv7bcBIpnPT6Pf1gboh/KOlgAQIV0DRGX3r28/rVxj0KKmXdM/z1lMTxHXSMLE5PQkpDsNEavF0XqqGZlFXgd1Sg4mZSiaV3/9h9FTb2VWNtbpsvtztVbdvt4BbTnrO6YtNv5ehK0/7kaArbOwi61aQtZson8/+gmZgnox2vDieBHhpCc6t3ThgB', 'thinking': 'The user wants another sentence about Python. Let me write a different one this time.', 'type': 'thinking'}, {'citations': None, 'text': "Here's a sentence about Python:\n\n**Python is one of the most popular programming languages in the world, loved by developers for its simplicity, powerful libraries, and ability to handle complex tasks with just a few lines of code.**\n\nFun fact: Python was named after the British comedy group **Monty Python**, not the snake! 🐍😄\n\nWould you like to learn more about Python?", 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 114, 'output_tokens': 113, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="server-tools-and-web-search" class="level2">
<h2 class="anchored" data-anchor-id="server-tools-and-web-search">Server Tools and Web Search</h2>
<p>The <a href="https://claudette.answer.ai/text_editor.html#str_replace"><code>str_replace</code></a> special tool type is a client side tool, i.e., one where we provide the implementation. However, Anthropic also supports server side tools. The current one available is their search tool, which you can find the documentation for <a href="https://docs.anthropic.com/en/docs/build-with-claude/tool-use/web-search-tool">here</a>. When provided as a tool to claude, claude can decide to search the web in order to answer or solve the task at hand.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L548" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="search_conf" class="level3">
<h3 class="anchored" data-anchor-id="search_conf">search_conf</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> search_conf(</span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a>    max_uses:<span class="bu">int</span><span class="op">=</span><span class="va">None</span>, allowed_domains:<span class="bu">list</span><span class="op">=</span><span class="va">None</span>, blocked_domains:<span class="bu">list</span><span class="op">=</span><span class="va">None</span>, user_location:<span class="bu">dict</span><span class="op">=</span><span class="va">None</span></span>
<span id="cb281-4"><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb281-5"><a href="#cb281-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Little helper to create a search tool config</em></p>
<p>Similar to client side tools, you provide to the <code>tools</code> argument in the anthropic api a non-schema dictionary with the tool’s name, type, and any additional metadata specific to that tool. Here’s a function to make that process easier for the web search tool.</p>
<div id="9d3aeee3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>search_conf()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'type': 'web_search_20250305', 'name': 'web_search'}</code></pre>
</div>
</div>
<p>The web search tool returns a list of <code>TextBlock</code>s comprised of response text from the model, <code>ServerToolUseBlock</code> and server tool results block such as <code>WebSearchToolResultBlock</code>. Some of these <code>TextBlock</code>s will contain citations with references to the results of the web search tool. Here is what all this looks like:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb284"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"content"</span><span class="op">:</span> [</span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span></span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"text"</span><span class="op">:</span> <span class="st">"I'll check the current weather in..."</span><span class="op">,</span></span>
<span id="cb284-6"><a href="#cb284-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb284-7"><a href="#cb284-7" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb284-8"><a href="#cb284-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"type"</span><span class="op">:</span> <span class="st">"server_tool_use"</span><span class="op">,</span></span>
<span id="cb284-9"><a href="#cb284-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"name"</span><span class="op">:</span> <span class="st">"web_search"</span><span class="op">,</span></span>
<span id="cb284-10"><a href="#cb284-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"input"</span><span class="op">:</span> {<span class="st">"query"</span><span class="op">:</span> <span class="st">"San Diego weather forecast today May 12 2025"</span>}<span class="op">,</span></span>
<span id="cb284-11"><a href="#cb284-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"id"</span><span class="op">:</span><span class="st">"srvtoolu_014t7fS449voTHRCVzi5jQGC"</span></span>
<span id="cb284-12"><a href="#cb284-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb284-13"><a href="#cb284-13" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb284-14"><a href="#cb284-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"type"</span><span class="op">:</span> <span class="st">"web_search_tool_result"</span><span class="op">,</span></span>
<span id="cb284-15"><a href="#cb284-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"tool_use_id"</span><span class="op">:</span> <span class="st">"srvtoolu_014t7fS449voTHRCVzi5jQGC"</span><span class="op">,</span></span>
<span id="cb284-16"><a href="#cb284-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">"content"</span><span class="op">:</span> [</span>
<span id="cb284-17"><a href="#cb284-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type"</span><span class="op">:</span> <span class="st">"web_search_result"</span><span class="op">,</span></span>
<span id="cb284-18"><a href="#cb284-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"title"</span><span class="op">:</span> <span class="st">"Heat Advisory issued May 9..."</span><span class="op">,</span></span>
<span id="cb284-19"><a href="#cb284-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"url"</span><span class="op">:</span> <span class="st">"https://kesq.com/weather/..."</span><span class="op">,</span></span>
<span id="cb284-20"><a href="#cb284-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb284-21"><a href="#cb284-21" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb284-22"><a href="#cb284-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb284-23"><a href="#cb284-23" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb284-24"><a href="#cb284-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span></span>
<span id="cb284-25"><a href="#cb284-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">"citations"</span><span class="op">:</span> [</span>
<span id="cb284-26"><a href="#cb284-26" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb284-27"><a href="#cb284-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cited_text"</span><span class="op">:</span> <span class="st">'The average temperature during this month...'</span><span class="op">,</span></span>
<span id="cb284-28"><a href="#cb284-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"title"</span><span class="op">:</span> <span class="st">"Weather San Diego in May 2025:..."</span><span class="op">,</span></span>
<span id="cb284-29"><a href="#cb284-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"url"</span><span class="op">:</span> <span class="st">"https://en.climate-data.org/..."</span><span class="op">,</span></span>
<span id="cb284-30"><a href="#cb284-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"encrypted_index"</span><span class="op">:</span> <span class="st">"EpMBCioIAxgCIiQ4ODk4YTF..."</span></span>
<span id="cb284-31"><a href="#cb284-31" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb284-32"><a href="#cb284-32" aria-hidden="true" tabindex="-1"></a>      ]<span class="op">,</span></span>
<span id="cb284-33"><a href="#cb284-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">"text"</span><span class="op">:</span> <span class="st">"The average temperature in San Diego during May is..."</span></span>
<span id="cb284-34"><a href="#cb284-34" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb284-35"><a href="#cb284-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb284-36"><a href="#cb284-36" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb284-37"><a href="#cb284-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Let’s update our <a href="https://claudette.answer.ai/core.html#contents"><code>contents</code></a> function to handle these cases. For handling citations, we will use the excellent reference syntax in markdown to make clickable citation links.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L558" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="find_blocks" class="level3">
<h3 class="anchored" data-anchor-id="find_blocks">find_blocks</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_blocks(</span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a>    r, blk_type:ModelMetaclass<span class="op">=</span>TextBlock, <span class="bu">type</span>:<span class="bu">str</span><span class="op">=</span><span class="st">'text'</span></span>
<span id="cb285-4"><a href="#cb285-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb285-5"><a href="#cb285-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Helper to find all blocks of type <code>blk_type</code> in response <code>r</code>.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L564" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="blks2cited_txt" class="level3">
<h3 class="anchored" data-anchor-id="blks2cited_txt">blks2cited_txt</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb286"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> blks2cited_txt(</span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a>    txt_blks</span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Helper to get the contents from a list of <code>TextBlock</code>s, with citations.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L588" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="contents" class="level3">
<h3 class="anchored" data-anchor-id="contents">contents</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb287"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contents(</span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>    r, show_thk:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span></span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Helper to get the contents from Claude response <code>r</code>.</em></p>
<div id="37f9a207" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span><span class="st">'Be concise in your responses.'</span>, tools<span class="op">=</span>[search_conf()], cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">'What is the weather in San Diego?'</span></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(pr)</span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Here’s the current weather for <strong>San Diego, CA</strong> today, Sunday, February 22:</p>
<ul>
<li><strong>Condition:</strong> Mainly sunny to start, then a few afternoon clouds. <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
<li><strong>High:</strong> 69°F <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li>
<li><strong>Low:</strong> 48°F <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></li>
<li><strong>Wind:</strong> NNW at 10 to 15 mph <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></li>
<li><strong>Humidity:</strong> 73% <a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></li>
</ul>
<p><strong>Tonight:</strong> Mostly clear with a low of 48°F and light, variable winds. <a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<p><strong>Looking ahead:</strong> High temperatures are expected to increase throughout the week, reaching 10 to 20 degrees above average by Friday, with highs in the mid-70s at the coast and mid-80s inland. <a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<details>
<ul>
<li>id: <code>msg_01CiY6bqkVHro5CXX1jVNjMG</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'id': 'srvtoolu_01EmFt11mrox1xAAjpz8f5QF', 'caller': {'type': 'direct'}, 'input': {'query': 'weather in San Diego today'}, 'name': 'web_search', 'type': 'server_tool_use'}, {'caller': {'type': 'direct'}, 'content': [{'encrypted_content': 'ErATCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDHytqFmx7sd0wZtPWBoMVuRuZbeR/aaIVSNuIjBHKonw0bRnrHAimQazChhrMg8epO2y0GqGgmIOlUY9O/rLBmIMQfPkKyH+stzbExkqsxKdNVjsSemcWY6zXdv6/1pii7wD74DjkS2wiJQzz+a60YceGulznlXIw4oLVHDf357qyyqxpy7KyMtEPt+yX6oRaSv2fj5+WtnXESqwG2oQKmUq1FItGMnrgMxFP+t/PeTmde17iEDUr52Zqje6jCqh5Y1+T5wDLf4HEHly6MXGUZGeq4SZYUqtVcVux2JUNiG/LoEwbov61fy6lSbi4zVyFe04bqlNc45pDuERe4pLuC1/TLQ7skaJ4kJZ3f/8n+Jr/KSkRtJXfUoCMT4Dy7SBztmBC/LibaNqfHu/D5lVV33NFfaokd/pbXcpMDsksNuBC+W0fmEMN+AGbIeG0ObbebLPHc+BdsS5C/JWrIRMm5hm+FWh7anWIFsyJRWVObLm81AJpiORAhLwep2Ond/3O9XXiiCFOoPxl8aikyAIw8V+knKiPJlHfQFVSnCr0+Z7YpR/AyBG74rgFpCx/j+j2dTPfPyKHnKAB2pO5j/qLSGYQzRCBUhCQMC/yGdapLCp2RVm3q+jtf6xGgURUPd4mmhZZ88FdTvA8jBGkBsMYtfiT0zbpudtog2v/lA+KZa4QMC6L9C9jCCA1bzkkeVUJJfjzQdMSRAUo+s427H3s04E+hfbb5Rq/VBsKl17vywOiiol7KMSelgp3SW6j5ImmjuFo2kZorYWA9hbcOMvFl+f/6dY36FdEkNxn6XQaAjw+onVTLLPl/obd36kuQ8qoOaj+bH6vHds4U4dMtAmU//rTMM9ZHQbf57gTrpgWgpdl0al2DXL9k5+nd7OURZDmNKH/DruIEIwpe/xniEQHSGWmE8PH8oH1o09jAnfoB+RANy8e4meHQN8PWz9xvBP5BvcRlpbcIsZb341Ikveel7DMIhDSlo1+9mCgDuyEvDlPzPWQkN5bg+ZLg8RFCc+x42HzM+wXFhUWsq0j9UmqkHwjgL5P3Q24ysOrTHBbmfvikJ/RV4FZbH0Tl54FwpJ6M9QdJ5Lu56ffk3YAWBZuxYAR4UwzMH2CMGiOp8kCLcrlI1BVyTOrZDCCR/9QjFXQig+CPaj7gFN9urisyAB7vQC9nepKf808J/35X/LPaEfEswzv3tY3vw9k/bwX7FFxOos+fKfTg5vqcN7q/7iBA7cdLvjfrk3ItfWqQwweBpMd2Av4+TbD1IMz+3T2VMP8KwSjthmX9u0FH/ds1gTC04DdEQ4RquEBvyzZZpF+sKtWAv8wQiQu5qzZOULjoQqiEgP6XSjEb6/SHBRNaV9ZChEqi3a4MNJXlf2uzBYmBojB2AXnupxiY/2HU6vhBghIy44frW+u9aAmxHTfco8SuT1NLK1clm6st5OZ1xvQd4dC+omsa3gZzOU8VADMoFvo88mSYrF4i+LIgMN3QxeNTqCnqRQ+J0YPZqUfrzUhX07/Kf9nH6/SrH/NF40bn1IV2ZuMO5KuE/EhzzDjc4AeP1it9eG76Q0LdN5yTkMsaBwJf5u0mRqDvyfflY1o5XThvv0NufK7GjfpGOP+DgR61UrNtN609+7DsT/YBUhYMBzJB/i7et6hCMPs5Npjm9E1GfguEm2SEw3zqo8AjCmGK0vuGTIggFnhaxPRplUoJQcpPxo20hVn3HfF8oUHAd+O70xCGQXYzoAMBM/N8tMdGZ4P9HsXiPQKMtkXog34lMXkLVyH9n0t7kvL1AOWJYmLNxpr74zAgqMYFG0Q/BqGcLoQvbjkcsIOgmhIVC9dRQ/i/q3HsRLccHtzM8qXVPi5Xc5bgv2G/ePoWgTi4PngBC/rwaLhwdiu2NJOMrGui75lbNV2ZMxvNovAes5mBMdKsVJ1vyvULENf5Onb7qaDjRwTUOS9qODGnLkQmOCVuAX7mS4nGqBGm6/na2YwGoy2yd/FhUVontLE7M7oiNPDbRp+2ixN17uUHrUaG/MvQZHaeN8d4Wy66xbI6x/7+pffLltrg/0a7WAuB2SRdQZS387wduh3L9CXawO7hSTQIwHgIRQNFe2/O/qxViXaymbF8tVOA9FDi0iF9aEKUvbVCW6/hFcfXQ/lxkhpgEK4BdMr/lbPIjogsctfYytbqGxKH8G5O9LZUXWZ6V/QcqJnJT2uZj5FCH3OLBeG0KJ5de45CVNODhXzMa1PQ/AOEhPjHof5Ms5/AZnxjts5OKd5reF1Yd0RLfqlimUhYSVuFToJm/vW0XCm6TOWlWMwQWxWMrPfjh15gz1fnVjLOasnWK+wD/TxD2HUnruOzXq5IgS090dLtLR+O/nI85jbUduTWfiW0/hIXuDOmrZv+L2xUwPB0znq+1a0BdtkvcGb7q4PZPsiae9y7xUb0CTNWYvSQoKl6p5E1TIgaq5Hu0mRP2kMTmNmOi9d3KzvwIz1igu2ty2DFBPm/HUXX7vY6CWpJ1rzA74Obx7mr5TTzFZpwMjWegN2yxXGEiFLRJAApfkTib7ba+l+vFxvbm1VPj6X7/5bOM8XauXEvoJHCOYscSyMl6tgP7w3BZqBnM5mogJ7KNLK4yFZMp24HszcB/GW8V5sjJcRkQnjAYhq9RaX+gemrfnTrQ0KC94BIuxL//Y3x52SzW9qst6dP6rLd1lIRmuoOt5XTDtal+2A6+jqu4PRSfid45xixBTGlLJwOgWYSmzSkYW28yojIZ2YAIxjWOl4wuHkV364Z2weUz5Hjqrc4Jtq1hwWdaM7yqEWc+s598BGTej3SCzOgs2aF7db7Z726gwNoBzlM4usK1QTkMbYOAT5b13PGJfQ90OIJX6APpbExI+mUJ5Lj1gpoDaIA0FVshTYQ7IxNy/Q7PxMRQWiCHF07oG7rY5w1IH70X5FePQbbnr1AvSZBgc9kqn7Og+ME4bLYXWsuqgV+8kEe076ceyvA0ytwmNmFzw/OCVkNO0X8hMGD41xMceERG+BnnnPXg4ZVcwSUwapFfi1+Qm1Ofs98EglWKxZrJ8MxuczSothjWtbk4kB9vS7q87g06n+lDhsPTsuZb2Dqekjg63/Xvv1cn6esYmfbZidPcdfEgSYEWv026jlKPsDy5yqV7vScpwUncRPWLMY274BMIbukqGb0buQYq46iRczuly+TYVZvdhHgBzlSA7shj5fzGgszPMeC8Yf6TT+Ck1mNAMOTLtQQNz9YEmLtiuFy7dTOIYAw==', 'page_age': '11 hours ago', 'title': 'San Diego, CA Weather Forecast | AccuWeather', 'type': 'web_search_result', 'url': 'https://www.accuweather.com/en/us/san-diego/92101/weather-forecast/347628'}, {'encrypted_content': 'EpoCCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDPmW+VGbGo5aPjqG4xoMfkBfdsdLoG2LM8wqIjAI94rS2DM8ak8JsDELXHQTXh429Z7xwTwZoTIOlQfh98VydUJkywIBIWgCXpOJVxkqnQFplIe+px4BQIADOma4Ifs+KlzYIWvXuUSBRMU1i/Rt7YPg1Z9ibw6ClQ1TA41tzl9ozicI1DcXWFyvftsnf6ei6wosLF/08ef3uKeIBl0JAjRW2VEVFz+1dYW3oUprmVq5BKF4K7jUSolq3YOxlOYjBnbqS7QJ4k4nGg19TFQTeFo2umdB3spC2Qkdq+8cIpBJ3CC/k1Pf3Ql7LJOdGAM=', 'page_age': '6 days ago', 'title': 'San Diego weather forecast – NBC 7 San Diego', 'type': 'web_search_result', 'url': 'https://www.nbcsandiego.com/weather/'}, {'encrypted_content': 'ErkDCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDLOH6/BHtC+UtVZ10RoMdYZ1dAG25M4Z0uf4IjABr8pN+SRe0h6KZJq8DqBjuZDvInCWkWuX05Rjt2KlYKzXnZ+JJwxnA/Nj61P6qVcqvAKHdVVJF1FGOyhxqm9GE9k0adScSC/RFNqwl9y4IM+xlhfwReqnou4RCCxQQglmE+7OA6vNAAnptB9TU1yqEWuUvk+fgIrXZ5jsIMtZWjy7KuneSeaHDDToX9pTPTPc5cF+rV2cTF6AbeC5H8Qi/WW0f2wv8CmAcyGSnJdkXTw6EEA7R8//lYwqPMEIkq6iyeL5R9by8ktrFKnmoQg6wEfH1WV3V80CRloeQWfF/XpIZc+rxKc+mkP55WcsvKiE9mc2uGQmFRpbNJFM7GUmHUyD6G+26ZU9a8B1kWq0Y7fZi86wgdExlrvCzZaPEyVnpArsz1r+4BDE9YULIVQbMBcjBdyr0OA4yTjA2xr0I2DarWp2O2ETG/2mtZ0FaLS5QSD9mELy+YxvaTYVHiRPUwoBtfFYd8hSN/j3LekjGAM=', 'page_age': '19 hours ago', 'title': 'San Diego, CA', 'type': 'web_search_result', 'url': 'https://www.weather.gov/sgx'}, {'encrypted_content': 'EoUNCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDLYoLkv9ACdnC87KJBoM5RlCXaY/15x/8309IjChtuk/BjwnlWWW137uVFMbjadIbuBUZMcPa0Dnna34KCsv/+5jyVs5Op/MjsF2NAQqiAwUHkvfHxBQEeTXanHxcW0rx60vzLgbZ2yE1Gj/e2fvfvwKDe6/lr3uInHPYu4EP6bI+ZlxLdYbtmVVrKubsOV7/cXgozBvP/hpWJphCgeB3Kvk7kEBSOuS9utPef1/zqULUbV8jM5OAnQmSEx01tIJHGn1rVj2Li3Ip+Mw1l0ej5Lfbyg9jvokRMQriZPoF9XL+U1g/X2+me0lC0CJiFg3jjlLV0aNL+ycpXnixndfQdaOoXuIdCG2jvWEujnbVYe4XdwIifkhN+WhB+1MkyMb1AbQkgSRFWUPkDa5m4al7mE2Ba0sp8PQlUNFQYXSkswyha2gvMPlafWbKFzRHujC/exCOAn2iFq87QKYSo7+cfSLACbW+ELOcuEfCOsYCQPI2xnZQ9fUfwsLoyHvjR9PLeurx7ntjgNr5NcG0vuJ6JpmYvVsvJ/pREb0XtJPmznoJmn27YTu39v4qiAsCW4E1YQ93CiI/TDCDaLFKNulwlT219ExUyBkkVXy27Vb1jwkhbz8UmuwvQj+8RzbnW63WT0xN96O7Xuxt4kHbKDP6UeUnGGlP3PcXSeBSi8GTf0aOizSqjS1Vy8Ud0BuhHUvYrpgeT9Dlye+bFusK833HN1K1BXe1Vw2CintUNC2Ax6VFCswpiZpBHpsppmsmkfSdVrdQrBVMs8JxjSSMhX9R02AFH+fe6Jo7SWQf0OdjbvkDusBC4J/xYdjNXwhXDU7QgCA9gis8zC84+EnF2sbeO6mddN2PhvGIHeZS0cHtTRhnDl6XGp3vJyudHokA/M5l0nZeVLsI1oRB/hVPkb88HxcYTeSjqlMQKZqLBagogbHwQpAg2pAal7KVr/BHgJMKfJQxBD87JwG9MozP6NUDjfLd8iT7d/PaFpaW3AFlvPBLmyL0pGw6Xm49JX77hJRzbAYqZr6N0jXoDwoex64uu7dooTGE13F9gOEd7TTmp+2UcvW+5yb8f+qC2NaIvNAry0QrF8oRdLel4u/buqLgCiO683iqgkM37yUDGch4VqBzSnLW8tdM+hpnZwFPhjghtkMwbihm8GrMtw1CxsuWiI/6z2IWwfmLT693eKM5qu6WgMj8+2kJJUDfzZWnG/IoJrrKZcfvykw39J/b5kwa0A9JY1sJ5+zX8ygv1Bqv4ZC+a8zUAtq3dh0H3CINcD/N/ceYCB5vvMHa06VjGsuRwElpiuX0FDZshUlVBxfP7aweHyNtjAAJNbVq22jY3wpldZqJqHRp3TrONABowXwyiIG/lbGiPckpYkFIHa0fKGk2QaRzTkWkPZVfNTWsOka2GFqHVmXYE/r3OcWkkn9BBYnkhMVFe6AJvQc8bufuQhx/Ml0c0Bdi8yVwA1xsIEcAQaci0eEAAnQbt4DEb0IFBuepdR2eHjVzi311hAboovNgjq72HmmxMpulQg+O7Zh6Wczv3S7YXMrTlERa7aDvbUgedbRAki9QtsflBRjTaVrwmI8S6zwRoHTzL1Xb8qT8UsR4eJCjI4EMjxKeA2bLRzzaJcWmJkDg01gFazULmbXMX0UM+XcGKf9HlRw0cE3ozTwLOKOESKvHhSq8gMmOIBnF4/pShfb9I59yu6k71ozHB5xyN1zYerxB32oZXzYtxrMFi7A+wxcTsnvYBOP9YKWa33Od/8tTaMdERZcm/zO4uYxJjKmWvXNj1f8gglN6jcf01Zc5D8BUqVWwqKR6gOQk6giVXV0RDtXUl1eJ3/X9LOR3hzfZXp1VIdmNIJ5SXQ+Pe5EPYxp8nv2O9cTcon//n/EuQ4yDjMJe0NR2/sHD6LaNi0tnMQsdgIRz6B0JAuonchcPOHwyaDEVGaLwojSoYSWhgh2/r0CcVveM8SPZqiNL43x1b6sAIzu4a+qJDa9suoTK9VqAE5cjmpYssSgsqmnq3/Mat9bN0/3bYfRG9TZCkmEXVlVCSISIIPd8sANhs9e6jZAYujOlWgQPAEb6ELq6Qk2I0OifVTqn0BXfL5v2GvEylgiq/FYk5ihCRr74cmFQ7FodYaoB3j+PLAhDyNK8SFHtz1F69BlaBlwkSt5Jn6jJRgD', 'page_age': None, 'title': 'San Diego, CA Hourly Weather Forecast | Weather Underground', 'type': 'web_search_result', 'url': 'https://www.wunderground.com/hourly/us/ca/san-diego'}, {'encrypted_content': 'EuYJCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDD8E5j6RXUvlgDH2phoMgK2iuOIWQPU4+KrxIjDb0BhChdLD8DyV2iwVtQ8MIMxqkj7ZVCdCpvf/O6VFVsVd+7K3OJC4mlxfmBEebnoq6QjR/iMPSPN34WurujQfR9lBUsYLbxHlFBKxfmtfVQL4d9+F013XGXz4e6LwcRgfDvAyALfhoR3wzSMldIAaRFMiqo0fm6MKortjmcC9k9x8dClnpzpOpyTALDN+CyH+s6iRvs0myEr0VDpD6cUeNTdJMwYdPFUSjUfSX1DYG5SizA9dNKNgAcIZ2UsGlUD//ACls2PcStmjQSajg3t+0wmS7f99SZ4KAAtnTsrrfwVJeTRWfjZAl3J+OzqOWuVDNYHYwUZoyPaSDQ3iMArVdvEt6FJKAORAaeXjyQDySeMkyglz5fjBG7f7dkL9od3MItobvdgUvols7j49wLCB6aJBMdyKngFMSKJxKy7NK0rQocNPg28jypoTFKREZqQEzqtQVo460KloaFukoI7tODNAPbZ0iJbjWEbfy/s9z54dLTaOISYmAmWwEmHBptJ8o/4/BDYDMGDVFUZecIwBcS0LqsbkE1Qlo7PCDOYf6uzjOJkmTLHhOq8frS7M3lhwZqmJ3DJ/bmmifEb+gF+jKaIuh1hMKLxK3oGeiHbEVGvNX0/VQbUZmiOT1v28LLrkeFHHy3doyhfjgZEQirkVBntwpEZz7Kj2chq2+K+R8K5YgSN+v+fqhde+cabHGkOtaPQ4QKQUggWYB/1tx4RztmZFU6nO++/niZxCpuBndcoyVe5U01+23ArS36OirydAZ5qRc2b1Z0jb9McqEhv1/Tk9mjCwYl/EcX4QDy8cHpolufMjhC591Xv9y6WQNz1bJk2oDXkf82sA3lbS/osrcT5p/b81/nSvuR8lbiHyILjFYLK4E3D9EF8FHi68SPpxEbM+NlShwJiSnlVmPfuJ7od3HPxtxcLTdFCbYBLpi8DAHHyLQ6UOE825URoq/dhw+u+S3cflvfLdNdH1eI8qPetrHhiRyju3BjMbqraotzQuv3IleyybgqTl2guUtie77SSP7YY/cLya27iYzY5g9kRNSRE/GxNM4dsNKTjaDEkcv9AxNSykhHq+f4xqE0+nD0n1IRMV9wqxwiqh+SUvMsBj/t1WzDnE7nqch/Zd0NaY0B40fMuFOR+PyHJECEsIoxMvprFrADTemM0xZVzFwHlbY3cCBWN+JsJfBcn4nKbunLd2H/9UsUGhHjO4fM0huv5QlzMOPOd8bJz0scOfM/zmPxINr5FN2E655pYgxZ7j3V/zk8CA9v976Jy8pQc1s64yqbhAQo2V6ZMmWTDaA2tIkwHKMi3S6QuEdq/1IiuqibCzw0mvhvcx7VXVIQeMcIDva2u4yr4PGv2vBhHgexUkmX7VZMEIgw6WFK0warFnpSx3LjigyH45MdA1I6jnHm8YFevAj5E+THssSVu+YpRe2YVw02UGFrClaJkd8VGz/eSgS4OO85fymEPKH3n/ny3soTDLy4RJ5UDPRLDfLrkAmkx5oF/t+zL7AG4z12K41y4iKJWr4CtiAnuwDgFOPl1gbPqR9zydJ6RuMm64lPgTbzw98e5/m1jUGAM=', 'page_age': None, 'title': 'San Diego, CA Weather Forecast | KGTV | kgtv.com', 'type': 'web_search_result', 'url': 'https://www.10news.com/weather'}, {'encrypted_content': 'EpsJCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDMCCjZJJjOuTE7338hoMkvEw85j6yFkTAJTbIjDeiWnqVdocqrSsrXLXDsgrhtOjAroFBneXL6kkSjTAZaC2a/WTFfYNPGXCG+SUP7QqnghJN4dtmMtq3IEDhmxy/9T+jWoYnWQtmQQvogQIdmRPxRWFIa6oUmXHnFgh1bK6aSRdeAQlVweJ3O08zkUxpL5bZLLBPT+260iIEb3O5z46hflTmVkZ8TnPK1WXXF9jq7vwdJKfPSRDD1l5q4SGlnK3NPhK2Xwb7alpIfjjS3H5S5j/29nWeZZX3K9DxQQysky1w/aKTgSIDEgXhuD8UlLcmix9NIwiHw5ypZEDIFqLZLKPEWf1/cgiqo+OBh5XJ5xD7VyfyyZFQuWD4nbk5O9YqOBN3Decm8DupB54rvG1jA2MYa68dvYXTqNNiVd2oP4nYi2fUDleVlx2Mcb5VIz3LSsaEJMHCW6ud389UErbgvu4VRzJc3zUTDkm0y2LWMmmVbJ9/HRt6DOqMjTjo5mdpOJ77E7Hxr7UiLQUTDv1vKToj0bRMBjLqJqEguds4RBF6fJ+kd8IeExi33Cv4icldiQtcYmh0Sj7AiFSQ+94y6tNx11E+GHZWBLyv0kwPrH2RjucBnS5gvY5M8B/GZSzn5S/ztEJnbUM9Hqxl8npAcrV+ZhD2A+/v0KUXkX+yWOL6DTOanx99NGbtq1K9xYXNbdbsQbiDOyaOxYAXYl1hB0HqIiy1p4sqciNDlpWTZ9igGZHegbtpG4M0ZToCUKv4htPNeB8UHssXm08fbNciCGSjO7MDcypce+TtEp7KqByuYAPg+2nWyryH47CoRQrG3GMf7GBT1EWxMKE3UbP17EuK5/3w3iD00ZsrvZhqIYgb0ytmA+HgmdB7T3vNCOmznqVGl49MT4lAzJcn6t8fP+nELT8ZRwwkpOho0WLT6wpxfHJ/zRdBmgGZvoozVl22w8Sd94ZZ8t9KCS1i9mwNhyJShHHoLbpWEUmn51UIcywJ7jXiJMcMN2z4xl2RSPsFY7ghheItIX8ItcVQNe3XIPQIaxw8t4P5VXTk2zwoUzNdLnus7Y1vKZ+7WhjQGTT2pVTs4/x95cF4f9RbDkZMvJ76Tc6520HtC7PnL8vtWu4UOPPBZBzg0ci5OsZotIYxRe79ELBOwg1nIyiNVU++xNWjC+AAJg/F7dttoT1t2WxIN5K/8ODgN9095CKpyFWckPiHrcDdyvHuxDzcN5o22mQH3NR5Gg2C1vDxPG9zImp22Z8lVz7yeW4Fb00dioulSInYcfio+Vavb4m9ncOrogtyNGEA1/EruyOWEHKcWnkGGnzceMA4QMABkWkBZ5rQmDwYdkOBJPK56lZPLQLy5P/gqHBA2toAEMMpzaf4qTMkM8WgCt8byGynjNg2FRJjdc3YZMt+IDd3e/ZiykKTkxj+BbNomht903Gtlkh5PjUIRT3CFI/u17JqPoHTg3tno3KMo8hfcBJ/CJzenSignK3yoCLg4VAXFg4B4BvGAM=', 'page_age': 'October 29, 2025', 'title': 'San Diego Weather &amp; 7-Day Forecast | FOX 5 San Diego', 'type': 'web_search_result', 'url': 'https://fox5sandiego.com/weather/'}, {'encrypted_content': 'Et0BCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDNzCV/HulREWIE7UGxoMavEi+rhChl6gS/pDIjAuGc3UixskBcE3fArDmyrQCMC7cgicHqhm0nwbxIHzTFYmZfdZzAfB5agKDVPlbXoqYUVYf0qPZKu+9kFo+Bg/kgIRIHzvImfqlhcYjw+v5pRPCJPWmiyE5ld0a3gA7WKqXYpcuR/epEKlSqo4ht793d4XCTlY3aueqd5dm1rZKhZHlGtgV3gzPe6EFIl89XfjyW4YAw==', 'page_age': None, 'title': 'Weather for San Diego, California, USA', 'type': 'web_search_result', 'url': 'https://www.timeanddate.com/weather/usa/san-diego'}, {'encrypted_content': 'EoUeCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDOO2jB9qhpAYdqTqhxoMkJl/f33zqYeYGs8hIjCH6uLqyK5ihLt1+7MgK3vOV4WI9UOR1vlnQ+1sRj0l/YQnMGbpaHYGwKIvh7Yt0zUqiB148CYbKLbaWI6k5UGAuRLX6c7XkDMwKdHgafQVp+V2mn2ggFCVOsON61tm1sza8yI6A/Z5QDWkNxmb83TeZbAqzq+dK/9qwXMoyDn/WYd3s2R/S6G9HKoUyp5lEiT9f/OBxfnib9HbpA2FcvREypLsPbHv+2q7XxQvh2Pj4VBp80TCxELYtapn/qoCj6D9QHQ8MLy/w8lFG29ATz/DBVjChrWWvvhB0XkiqKF8cq4FFqAyTnC++LCOlmJpBABtAWfEosP01m5fwvE09LFhPx9SpNcb6EkzTjg9y/yuxfgVBmqvXNFW9SFc8ZiKY9RGbqZoSm43SIKFpL/2FaQqup5IMPmjvM+whz3FE/LegYdq6leXf6IL0kpxi6QF26Blj1BBKAnh1Mcm5deOOXd0PJ2lP+9cSWmrrv0Wc8LdB6y3TkDm8OdYrnQ8wY/tCiTBBeJOaUfDRGlPD1MkgFzqdfzC625B+9thl0l3ExrRz8bTx5pC3AKSmq+2K3ASDOW/hV6aORazpZNLcpjXA5VJdYOmdSkJaxdW6eWAxEfl0MvZlpZAwzPAQjmJ1OQ1OC+EXP9fBpy6rQlwF4FbXaKEe86o8NAzN/+9tF/FZV8hD/hyzznIa3k/4bpC+pGcLH33lnYIU1qCB4GmCvijyoyHWGVgNtY1jI3QkPSvrj2Wq2a7UlFUeJUTFDt+BRbUQ6bKWwn/eY0pMLVmcAf5AG0oQd5j/upOApKPxYEvK7jrL8Cn8IaNo2e1zrKuCge53ucutZMd12ZjE3oQ2n5C89KK5hVP9bUL+IRUJrLGQ6NIUVw2celtkXtJa6IsfebpTZmjxGE0iTXE1PKmVvAKVFNK26ILa8u+gkVeINroLuJcwhg/pd0YwT9PCD1Y4na18IO//u6u1zZ+PYKUPqanYXtU2nNYgQ9OXpu7e3LmqxVzQNJH8dvcofzEKu9ovFpgtyjCPQIXCbwudECKophlqA/nE/U++8nYIbm/4w3vtCvzl8s+99zlU0j1VkhsHgJR/SOzQP6Hu7Yt4sHQ6Umx0TIMbxkk+9l7ZUwVAFUUa5iXag2sXYgxIy02fqwojGjz4/8wY7izYIpuGfGjcVIa4H7rj+rv68pEQYMOJ2lYz+l5/ESRU1l0st8feRQHcgPTdGIPwyQNbsxgR9s1h+SeNP1r/KCwoD9RWDjIvJVQn2OoLQJGo4D8Vgp5AlYJRRGlRcFtPitX6Bc7hO2syIC3P57sI+a96ORRZqR+1Q4u1si7fBrbKqGw8O0KARjkFGI3dl7gYhlpM0F+IwdedlUHQRvIxLRh5q3KBmDnRItbOZZEr5vWiBhSLVel6z0AhOIuE14Y6ZZRmetBlux4VXkP9bfl0zdVRkKoInW+qo3vm0qKwI0BvsXBmnfs9A792Kwr49hvJVe8w/ocsGQXDlggnAEgMHMj0LrMS5rYHl0hodv2y86dxdQoLS9+zoKGzn0EE8n6h1BYlwOayVvMHXvcyD+hEpZfbC6nC9R+Pr/NtmbVcCaQ6jMLSQOEoVvU9AsMRG+xTjTWtBXCJSdtTVPHjx+28PpFrRukMnltnyhoVKrYW/OuNFiW3k4Hn4c3cMtmOj8D7r85VraTrNdc34K/SY1a/r5p6u0H5d1sVgQDPtrt22ZcHwZz6SBZAIsDCGIJwSiz4d4WFqpeEl3rD8hIMzgsQzcXCWWLxI1wd0FyQ830UnRTgUlU1FIqB9CydHmW2OqDaiFoXYSF4ilOW9bfMQFdZEqbVcXEg2549pdLztYBB7VOsAN72AfKUEbcXgXeiJLRxJPmGdDAH8HSTCRrAvB167SRgV/GLC/Ba9/EgvxS09tkmbWCeI0XMyrUD8ZwBetvqapIWNVW75nZFfeuS8BcChly1+jL7H1kMLy+c4EQpkaC6JMmtDagJyX7t2y6cSs6CG2kPpeTiMUu7leRypLRCHADj8Mm1/QUzKSywnO3cz4beclwkAkpcG6GsyaCmUk3wozqbM0uMReHfP3b8dzwxFfKbA0C+k8vjF8ja1m43rpoDwrPCf9zH5YNx9/7kihhwttogTmlgb/rC6Rs3xZAh1sgxxecHFQaK5JYf1D+AAOimYNmPJtgH5sSgQhC3qk2D+1YxgBDZyiQRQtXHFKQnNtJFAxs/suZd95PS3ONodvc7whdqV/8nCSLgxkDrgk2mrjcXU0NANuRFfKuRRDVKjVVLm+iry6MxPP9zsK41ukwYujt6TksriSY8uya13mg5jcxCuoIKfm7RcyuGBvRtnFsAoU93Mj14ks6DVGB3zlIUItFtGKfBlH9X7/xWyFqHzDVed/kxwy895YBtHqGIFhjaVq2T6ERifZiLKb4soPqaDA9Z4p7TZtx7sGq0jHtNfFCZbOQjFA/zXH0JlTDsb+CSZKbRzm90qi5nQREp/mhWT8efOA+qD6OC8C18Dg/uq5kLabIzE+zFOP3wuvXvDlGB5hDVVzUWoqsWglhrdSrP9XjkPxaVgCU4oFG1Vjj0s/7biK7/7ySuTF/Pc2gV6s4HO71VQMWU3wWP1isA6s0BGVrCNBe/jKFI8Qoof6csDcpPzZ2eqPa4Gi5bYmplHQ60gkEopokZjC2GjOPv/W5yCeCHVIu4Z/6obDv7u2X+gzAjgx005fCmemFpv/BpyVo6opD+6B5TcgNmql2P0YEPR8jL6bRnW94mcgQaBOAgj61wPv//pi04GTXvlNCDj2memM/2hXx2duhTayujTQhCX+GTtdyNM7c+WpU314O7aDfRuBXF75bm4DEQu9sI36go/DLjmGsUjwWhQUyf63y8/kso9UsrXt+/aGotCYyttT4xyIqBHvl7ZEnsoIO8DPcuqpLambVgSI4UG5CNYU0lckXUkBSdlqu/ne8/1omoOkzkykCpJjzbwiss0II77ZV3lmluvTrTzX0lJZbjdSgS/o06Rcx9BgJYqcsAEv/5yOsxOtTY04kF87Z+p0Q3GQeEpCmYpPKFwJFep9gLu+0zuBD8Xuw9k5alfR7KUpKwgrVOAE9//pk8tWrTV7MnHM29e125sai1spyb5d1P112uHW/YQaqYLBZHUY0UDIgr+Xp2ALiYplOGHey2ZOYBoQ77J81lUmxVXpwXTupt6ZMuZAgMtSnLBJslH8Cg4ZqATrXgaLfGI+f6lEvHMmkrxHNKfHuQAW/YTgBo2jGG3mtl+PYfPCK4wBfGXr+foOgj4fCvIAnF4qvLU5tSX25A1lzDjFUVDS94559EtypAHPU2ITSgFsnoRQS0c/PklRHE8uM+zNb2lRRl/wsp+riTayln4sq6UtYfmaKrX13o5y3BjpQtkc4wUF5c+bbrBECAHWi1ETEs6WPoIs53mnAwfX01YmKAoA8qyVdiW1fMF+CJJzbw3M5uVLqi6mI+vc9eJqTz8v0Jz0znrjSys7KV9sxz00qbkjLaFNFfI1VpRo1EZmFkSYHAg7mNCF2amSUyyo6jL3R8q0m62zgShiWm1zZo3FPz6VSer/uniHA/fVBHGtCkGOOv8wnaq9HF5Gt1EE91P3oUIszJ0xpA5iNklAv0wOO4SjmfGn6QON+/qflqmwsWMHqDqeZc/7oAYnJ0uDfQdTlRR9L6i33sbwe1ue6dHKvjZxVye7/oFaB9t9srzkg8yZVAPOtsfmWxSMgi0zb9aOD28Ink0rEesc6KN4Ij7ENFo/cQkPsTzKAwYv4MIMC35UIHUYQQX3ry8Hx69MwzjM2vN+zRSnT+gfThRxvfQvemCqF8eSgxL9URsv5/2XeYCwGqMfKWbx7VMEZedZzv+ErMQ74aBTJqxW0wb73fiQiyvT9FZqgGfIBM27/E7KcsH35Z1CDKjZZt7WpBJV9uCznkiv95q13UEG3HCRPfYfpwi7v8Wl3d1/4xEJK5zEYAZPWptaHlCLMoiCsV6ws/0UbQZkz5Da6cQ4qzklp9AF94/CBofAAMGY8yzQsd+gug06QTpzo/EHKY35VBGIw5pwqilWLnI2ftV3hQ10NlrDTfbI8HFo0HDuymlH4kiAfYdn6pvh8PKPzoORLqbVB1pZQuvBtYW2Z9oZAJTtaSMeCCx/bHeEy/jfFQLTTLzGzrJ+kkadVkFZG8Rttu0qf0xj1Ye7poUJ5XhIVZs8mHbJ/8gV/XPIvKamgGHaGC0a4XldC0+Y48iskwSU0WuOrlWg7F2xzYTWb5hHE6BOpvnVAizIOzIvGVScusUrFsQ5EYO+mIa7/R30ekKN1njjngi45B77VXuiAkORjOItnbzMhY5Gj5hcyLA1wDcUbjTxDOcuE26kWo4cmCQ9ok8KQ/8ihQgMYrJvuzTSmTufs75A8d4DcEhTpxjb5trLDqgwxOlxnt2LqhgwBRwB6VeXlmRn5EVBZLQDuYw+MkY2Ru9DrKY1Es6cPH1CnYz+fzsA5a2sEdGETWkUQupB/7D0nF8oOPGX7hCnhZ1JeOpaF698GUBwuvY9UYT4Sw/VBGLxqDqmo+SYB5zLIMjK8gRd7Q3yk6e7tffbVIPKtkCOmjCRCzyBUbMvylyA5tAzbB94RAuQLtV5ebvxp3LtDHHb0dnJEBSLUU+/s5zYNH5gdIgbvmie3QTZUaOFt2gAXzsCXF9EOhCv1S+1aNzaOQgcLO68xXHrZ3Z2FgSgU+EdzwaB8nUHl1mCnUcoxTgeLIwM29f8xLHK0Z9z+6jvd81KzzN0qVISA1zY3fB/Yj56kqm0K6Ql0Nsq5VJZnFi6uRpfOsgmqquyxs7kCB6KKNlNJQcBkGX5Jz1Q2UwchWIaWr969+CJYksjgJ+boAv8QBLlwJ4XT2yeut8xfky2E++Y3Y98KTpjfPSWQfEZ0ah5/FD4lT9G2v+jQI47BR+8Neu9YMGtxtGFQIjw2qx0x5rnHEpzHvf3CvTvJkyrsoNnZbBlwzHhCuNEaZ35oAeSd8QR50iFEgQ6z1cOKP3Z2YjJXsVodHFroZtDbMuuDyVTkpJsUiKIeZzcYAw==', 'page_age': 'February 14, 2012', 'title': 'NWS San Diego (@NWSSanDiego) / X', 'type': 'web_search_result', 'url': 'https://x.com/nwssandiego'}, {'encrypted_content': 'EusSCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDGHLHQz/u+lK+HVkVRoMIhb53TzZYQBlXjFKIjADxetwtH46j+cKj2VTYRgfJdfe2gvdFm6r6OOVZPqk7RP+ig9KeEMMM/Lzm6j7INgq7hGCNZpMn4H58fcomN2uGNQp1D7JO/+G8QcjBbboDOJnupFP/wd1y2HIOn0VHmcTv1SQE6KZify/OwEWoVufWpwavPYZLz4sepINE4XeWvLc6224J1pe8ZtaF2cbqdm8gHUdwqCAUhrSznP6uV3BeO0IemU4oNlP7KOJ6+cmSjGG0MXR/vFtnqhX4oX0z7x4LDMUmlQ6gXEPxl9j1n2cRWGisRusIZXE9tywrZ69NAw5QgJ7ys6JAqVpXSLaxEIXCBZx+NUHW54Eh1yuajvtA8HcfTKQQqBGv0O2Mz+T4p8JLhZlvpPFBNXGXiteagTMYyxHlzkgsIuhUhZ2gq1S1OhRFaJLDBpjnfx2rnChYRl+Hdn8fH5JefRWJEyPxID90weai1qVaIjwLkp2kuX0DgeiyhSUqT3Dtkm4t16fVxnXlUsZMWFA9+CZnychFZH8AS6N18yws9bZXffJQbN3UFA7meU0PZSbxMQPG5QLjDvhvlzHnyQPNNCY3bqlEhCPLW4PgFAs7hsQz5vewBuXIMPVe10bonfBjc5LIqFGVz7suHb03lmCRW1iuurqCc+9W+/8MTGMCL/9eGptvfHE0L6fo7DOQyvhs5J0H9tZlI2Drphv4xJ+05wxFceuy4FBw5Ta4M+TNnulxO0K8zHUbUBmiaxEh9AHBg4/A88qrIYuhQgKOg4qoXCSiH+R+0ypgLG4OVtTWQKL8Or6fp79/25lylmr8I44133dndHSaogDwYUbSbWwceZ1up4/ZbP9kp3QYgJM26pf33IUkLXW3QBPA/GIFcQVXTyXqFRqUi4iDZpBaHryqX8EugNEctnjN/HerDvFKrbNbSHR/DExnFT21qUPSEb2bhFOowsxScxNA7315BflZ6DCCEJamxjkfBf7HYiNvF1PkUZF0XWXQ/YZSu8Bu3pILD36DLhywlMheBIk+kvZL++33GmpDpcpCglIm/odxdtQwRJkpvvsi2Z4icTHxHDJh6KAmLFwP+juEYvMENsBlkTZM4Joy7cJRZRmdVe9re3dcewUoOMGX7BaMDvtX+1d6TmXiDogeSXMvXD3ZCbcu/0bO1YErHGPUQlXBsZDoPPoz9Z66MrW6hF7v76UqwstyxezxDHQ4AmG/UBff5M/1bbekcKnqXUuLl+L1VU36MGnyXwEKQYiZu0UqoxeLaaHQry+np6lOd1C7VFd6xvUdNkQMDRh7VuuIy5RoM4JWqDrMTR64XMQn/NwMYI8TqIb5P8W7fMOTLna6N2L/x3fbksdprEdeFEVH2RcdDDdqDtrpcOuABF5ilo6+EYuSkPvWU15KeDmpJf5tJ4xn80uCJrmLNXDsQnLbXOMF5IPM6SCSGBukX5qErgIgJErtNUeborhuvYPSV/hEPgbB/jYnKuPZuT0OpEHdoVcTA/No+WBxQk1fJUkwYNFiobvq/xOCrDPmQEMFR+WD3DroNNQ//pJNNqajIn9SU1NUtMEVkE6RR2OfTNWX/dFGQPdUHJtKze08nEmibYJDTGftK1CG/JKi1kW37nKC5f9C840gEF9pQwSJuzik4rUdgEmwwDtiJPBKSWxvKnxJkGZI0TAsiVddiAVhSQSR8JZ2Z7x9liIXAcFKGj6okxee7/waaESeZ52z6ohdZBmlEr4p8vI8yDv1gTOZgSFiO4p8Z7KtC6uAEljp3QurkTORTElZoNtB6/Lh40tmCprz96XDgYI6WlHp8/KFFE3MfBXAtwan2wLyyhEaA7dluTtLA+d8ytKcIDmlxlfzvIyoiL+tLEJPJzX4kiMKGDmaa9+a0rTrpGhFpM+51D48j46aPgApALwwTh+lv9Jbm/LPsFki2jknsV1uQZCypVeJBlNEidXZeof571Jsi4gigs5OYBTCrO5Lsdv+31CMNX0wqGns/ZPsPnUei17C2BmrD3s38y9BcME6jQ44ze/MVXUxWgJCHqyrX+gvTTx9wF42eLrPi2gVS8xw8KTNzeFp6Q0itUzuc+yW2RITdA1inTerPBB7xLxQNp1O64zOV+71gkK4rEIBnrFuJQqUIeeoTaOO1bY2lfuWZPIHnmMsz93aO8Qdmrqs1TTKoI0CKa/1HXBwNV4Cw2gfhymbyBBjQfXQfU/wOer5qtRbYAS+mP1HarsQzOEIFuGalXGyBufQ3/vCSdqV8/lujfnMCq563fSkrUblu6W4dtVDeu6u7r/Hb3g7Wr6FMhWz36aoBz+wKWAptHEnjEmu+D9drF0vxglZiUUJ4i/NMLH9/qttD3szGKLQCAoVo7ERbxwyVQ9IBeGG9GUEMT5uCSOzWOzAum7q4lc8TXuA01h9Cxgu/3g+OqQJrmLblcCAYnvR0mKpEZHwYfdF/CA3b9RHl8S1wSLBhRcMzzL++r4P+0rGXjVSsjeMPi+WEANejUaH44VnpXP/NbbIjIIvrZXtd6uUFalpv0rZl8C0Inkm4P9lX27Ef29yBqo+ma/4Sj9XnJLpgQECNdmXiRNyL0kBFTC3rZ5JF2fn9uCPNH4Kk4n/IqMQnpUWjzRMbKsh9FbWMl+Nvcnx+fhGirR9RPx8F3s4utAKYOKp2GWvFdgNgdW9DbguZBr4aGB1O+7F7IxbBJAoBb4Y+DeprPTWrAphISedalwH2cDLO/SEBNAdErAQiyNgnS+QZL8ZX2iFTkWI+Q2c9238PKwnGc+xO0DlsV4nU+36F70ynGuS3kxvTTpOKe9mv++TV+303qRZLqBisbLbsltkmaTYwPdTMT54TYpBloMlVmfP6p+07A2JVR+R/4ktWHII9Viwj359KFR/JNo7FDELambwIt3ew0Em1xbgHXJNOeJ1bqxKEIazcJci/U/rO3x5Hqyu/LQrOziy5nmrwiTLWZ+Jee+UheOVv9xCU8O6qEPu1arBKx5W2X8cTXvnH8DjRmY1LQIKPNpjB2o2pZjNGhIU5NI9MqM9M6RdyXTRzY14TvIGrxXvUB9WTpkPeqbaC1OAak/OS57unhs8n8ELkf59cwImtmE72CYFY5XxeQVkLw/YN8PSeC3dhdNX35p6ykBhNfk/4NEbE8YAw==', 'page_age': None, 'title': 'San Diego, CA Current Weather | AccuWeather', 'type': 'web_search_result', 'url': 'https://www.accuweather.com/en/us/san-diego/92101/current-weather/347628'}, {'encrypted_content': 'Eu0ECioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDC+eBMbh0beNMTdcjBoMPVDl1mNgtMDF/i7dIjCL3csRo3DyvtCpYVZ0TTHHv5QpXvXtEtZucEyNAYBUuUGkH6Uwkvw845Cjes6Ss9sq8AMHwmRl1bzgKcjTkQJaGL6mOYBEAaOOTbSzoKRsC/og9sbJYZahLQsytqSRB5SgrXRxQgahjOc/aL6YjNShu8lw0KjOXePKR61KbTogOrKNrcsfYESVJpR+pRORnMXmPe8IdnCsxZ1d8l3Eqbqu+wzi67Y7JcXvycg3Ee++F+2NdSv/c345BbcbLtMk1zS3uaatEPSPErphiMzJjMaz983gd6U17C+nl02DKRkT/nU6hAsVe25wEvrXsYu1+I6i3SpXgefcLxxV3LIqqclZmd3nQPj+UzSrP3q3wXj4uB5/isnCl4bK8rfnPSartxrhVjntIDvZGmkaIBgMB/nl2CINdcBka+xJkw982idZ0ifmFEzDaJk5gFud6E8vB16/rLJYy5J5Qf655wJ2V2Ry7Fow3cDOlNd8ZKl+SqxmKtC1iHVhmyXqxMHpZmttGyHSQJOlIDDK2y5azjTj25+lddmNbtaLuH9zp3NLZsxXB8a5gZFKIvPgegQnsW1sMUKkygXBb0HeAw2FmJC5jKFzXNHvri7bggzfu6L+V0cE0dvnv4aVjPiyKph8E/dJ1jd/xsLBkONkBr1i6DkYX3xgAEFvnEluKrFucEIEcoIzzB15TlZYnLBYrQDRVARg9KDnDESe6kc/McEzK55PH9WInOGkGAM=', 'page_age': '1 month ago', 'title': 'San Diego, CA Weather Conditions | Weather Underground', 'type': 'web_search_result', 'url': 'https://www.wunderground.com/weather/us/ca/san-diego'}], 'tool_use_id': 'srvtoolu_01EmFt11mrox1xAAjpz8f5QF', 'type': 'web_search_tool_result'}, {'citations': None, 'text': "Here's the current weather for **San Diego, CA** today, Sunday, February 22:\n\n- **Condition:** ", 'type': 'text'}, {'citations': [{'cited_text': 'zoom out · Showing Stations · Hourly Forecast for Today, Sunday 02/22Hourly for Today, Sun 02/22 · Today 02/22 · 2% / 0 in · Mainly sunny to start, th...', 'encrypted_index': 'Eo8BCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDKPnjrs9hI81UdheSBoMjOEBwau6ksWBtHPSIjBSGb5wiRTDaDToTYzb06X7vpO/NAk1SOD79RwkX8u1xbcqVUpcQJOWtNXPXdKGc6kqE+T7ttYmZQIDTaXTSG7TR/6PGtsYBA==', 'title': 'San Diego, CA Hourly Weather Forecast | Weather Underground', 'type': 'web_search_result_location', 'url': 'https://www.wunderground.com/hourly/us/ca/san-diego'}], 'text': 'Mainly sunny to start, then a few afternoon clouds.', 'type': 'text'}, {'citations': None, 'text': '\n- **High:** ', 'type': 'text'}, {'citations': [{'cited_text': 'High 69F. ', 'encrypted_index': 'Eo8BCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDBxCY+HYFWzXa/eQ5BoMPJFKGEz/4bLKgNYSIjD3IvzFy8S+Ur6X07t4RyeIR0/ZLGLTr1/650UZ93tw81lHOko8MJ7w83lZGKLMHo4qE4hnkd/a/SnrpjD2xx/D8bof2C0YBA==', 'title': 'San Diego, CA Hourly Weather Forecast | Weather Underground', 'type': 'web_search_result_location', 'url': 'https://www.wunderground.com/hourly/us/ca/san-diego'}], 'text': '69°F', 'type': 'text'}, {'citations': None, 'text': '\n- **Low:** ', 'type': 'text'}, {'citations': [{'cited_text': 'Low 48F. ', 'encrypted_index': 'Eo8BCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDCfRLDkRQlN9Ru2j0RoMNrMvsZ2P6dpavhJmIjClJV+JLmfYoC6q1mVtUpfADT+usthNfmaOqv+7Fm2OHUDezfL7XNCvm+k2eb81kqoqEwQO0t5Pkl9chxw4zxRTA0+RxXEYBA==', 'title': 'San Diego, CA Hourly Weather Forecast | Weather Underground', 'type': 'web_search_result_location', 'url': 'https://www.wunderground.com/hourly/us/ca/san-diego'}], 'text': '48°F', 'type': 'text'}, {'citations': None, 'text': '\n- **Wind:** ', 'type': 'text'}, {'citations': [{'cited_text': 'Winds NNW at 10 to 15 mph. ', 'encrypted_index': 'Eo8BCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDCUBdvhnZQj2+zDAshoMaWIbNAYyQ0Isx7qhIjBLGGiVXWEd9aIvyDbbRrqeg/Vv2C59yDUSOHIXhhCgCOcOWg0BXYDQuZHox/I7x3UqE3X8jaHlFlx5i8fCxZYsvLefEJQYBA==', 'title': 'San Diego, CA Hourly Weather Forecast | Weather Underground', 'type': 'web_search_result_location', 'url': 'https://www.wunderground.com/hourly/us/ca/san-diego'}], 'text': 'NNW at 10 to 15 mph', 'type': 'text'}, {'citations': None, 'text': '\n- **Humidity:** ', 'type': 'text'}, {'citations': [{'cited_text': 'Weather Alerts · , Enter zip code to change location · AK · AL · AR · AZ · CA · CO · CT · DC · DE · FL · GA · HI · IA · ID · IL · IN · KS · KY · LA · ...', 'encrypted_index': 'Eo8BCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDCTjv+m/hjq8As8IwxoMGQlayvWmSb9+A8hKIjDY+8aotwhJ05D3rn4qP4u3MgUvTL2dnvmdIpYybmCaGQrwOCjpuKVwVq40ozuEbbwqE3kYV+eQLCNQKXRE2S/nyZMqM6oYBA==', 'title': 'San Diego, CA Weather Forecast | KGTV | kgtv.com', 'type': 'web_search_result_location', 'url': 'https://www.10news.com/weather'}], 'text': '73%', 'type': 'text'}, {'citations': None, 'text': '\n\n**Tonight:** ', 'type': 'text'}, {'citations': [{'cited_text': 'Tonight 02/22 · 14 % / 0 in · Mostly clear. Low 48F. Winds light and variable. ', 'encrypted_index': 'EpIBCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDHOFAnCo7mjGSRui9hoMS8ribfl6H67/LfWMIjDJ21oTZ/NUzd4mIHe0bf+CvA8WJY4O57xQoKsuj2Y3RvA5V49z1WJ4kcohYt9/RMIqFuZDjilpgTI9AhMVUfC8H5YGzvMY1dIYBA==', 'title': 'San Diego, CA Hourly Weather Forecast | Weather Underground', 'type': 'web_search_result_location', 'url': 'https://www.wunderground.com/hourly/us/ca/san-diego'}], 'text': 'Mostly clear with a low of 48°F and light, variable winds.', 'type': 'text'}, {'citations': None, 'text': '\n\n**Looking ahead:** ', 'type': 'text'}, {'citations': [{'cited_text': 'High temperatures continue to increase throughout the week, reaching up to 10 to 20 degrees above average by Friday. Highs reach into the mid-70s at t...', 'encrypted_index': 'EpEBCioIDRgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDP2q0p/VI0gCB2a1KhoM0pPJHMZHqghhpS0yIjCf0Mv7lKMuxsBEUBUPcXBlN9Lz7hXdXgePFC6xTr7G747EanbklIjVjTCcbGLWDNUqFQwGIjUA0WzAMV6otmRq7amSKNqOGBgE', 'title': 'San Diego, CA', 'type': 'web_search_result_location', 'url': 'https://www.weather.gov/sgx'}], 'text': 'High temperatures are expected to increase throughout the week, reaching 10 to 20 degrees above average by Friday, with highs in the mid-70s at the coast and mid-80s inland.', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 2227}, 'cache_creation_input_tokens': 8771, 'cache_read_input_tokens': 2227, 'inference_geo': 'global', 'input_tokens': 4, 'output_tokens': 337, 'server_tool_use': {'web_fetch_requests': 0, 'web_search_requests': 1}, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>We can cite custom documents too.</p>
<div id="742594a6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb289"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> msglm <span class="im">import</span> mk_ant_doc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="bb9e4bff" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb290"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> mk_ant_doc(<span class="st">"The capital of France is Paris. It has a population of about 2.2 million."</span>, title<span class="op">=</span><span class="st">"France Facts"</span>)</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model<span class="op">=</span>models[<span class="dv">1</span>])</span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat([doc, <span class="st">"What is the capital of France and what is its population?"</span>])</span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The capital of France is Paris. <a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> It has a population of about 2.2 million. <a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<details>
<ul>
<li>id: <code>msg_01JrDTZVtNzSi1MyjPvPF2xS</code></li>
<li>container: <code>None</code></li>
<li>content: <code>[{'citations': [{'cited_text': 'The capital of France is Paris. ', 'document_index': 0, 'document_title': 'France Facts', 'end_char_index': 32, 'file_id': None, 'start_char_index': 0, 'type': 'char_location'}], 'text': 'The capital of France is Paris.', 'type': 'text'}, {'citations': None, 'text': ' ', 'type': 'text'}, {'citations': [{'cited_text': 'It has a population of about 2.2 million.', 'document_index': 0, 'document_title': 'France Facts', 'end_char_index': 73, 'file_id': None, 'start_char_index': 32, 'type': 'char_location'}], 'text': 'It has a population of about 2.2 million.', 'type': 'text'}]</code></li>
<li>model: <code>claude-sonnet-4-6</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'inference_geo': 'global', 'input_tokens': 604, 'output_tokens': 55, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="third-party-providers" class="level2">
<h2 class="anchored" data-anchor-id="third-party-providers">Third party providers</h2>
<p>NB: The 3rd party model list is currently out of date–PRs to fix that would be welcome!</p>
<section id="amazon-bedrock" class="level3">
<h3 class="anchored" data-anchor-id="amazon-bedrock">Amazon Bedrock</h3>
<p>These are Amazon’s current Claude models:</p>
<div id="81d16826" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>models_aws</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['anthropic.claude-opus-4-1-20250805-v1:0',
 'anthropic.claude-sonnet-4-20250514-v1:0',
 'claude-3-5-haiku-20241022',
 'claude-3-7-sonnet-20250219',
 'anthropic.claude-3-opus-20240229-v1:0',
 'anthropic.claude-3-5-sonnet-20241022-v2:0']</code></pre>
</div>
</div>
<p>Provided <code>boto3</code> is installed, we otherwise don’t need any extra code to support Amazon Bedrock – we just have to set up the approach client:</p>
<div id="08cb7585" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb293"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>ab <span class="op">=</span> AnthropicBedrock(</span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>    aws_access_key<span class="op">=</span>os.environ[<span class="st">'AWS_ACCESS_KEY'</span>],</span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>    aws_secret_key<span class="op">=</span>os.environ[<span class="st">'AWS_SECRET_KEY'</span>],</span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Client(models_aws[<span class="dv">0</span>], ab)</span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(cli<span class="op">=</span>client)</span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"I'm Jeremy"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="google-vertex" class="level3">
<h3 class="anchored" data-anchor-id="google-vertex">Google Vertex</h3>
<div id="fdb46839" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>models_goog</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['claude-opus-4-1@20250805',
 'anthropic.claude-3-sonnet-20240229-v1:0',
 'anthropic.claude-3-haiku-20240307-v1:0',
 'claude-3-opus@20240229',
 'claude-3-5-sonnet-v2@20241022',
 'claude-3-sonnet@20240229',
 'claude-3-haiku@20240307']</code></pre>
</div>
</div>
<div id="30921ab4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb296"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> anthropic <span class="im">import</span> AnthropicVertex</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> google.auth</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c00ef664" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb297"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a>project_id <span class="op">=</span> google.auth.default()[<span class="dv">1</span>]</span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>region <span class="op">=</span> <span class="st">"us-east5"</span></span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>gv <span class="op">=</span> AnthropicVertex(project_id<span class="op">=</span>project_id, region<span class="op">=</span>region)</span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Client(models_goog[<span class="op">-</span><span class="dv">1</span>], gv)</span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(cli<span class="op">=</span>client)</span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"I'm Jeremy"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>France Facts “The capital of France is Paris.”<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>France Facts “It has a population of about 2.2 million.”<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>https://www.wunderground.com/hourly/us/ca/san-diego “Low 48F.”<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>https://www.wunderground.com/hourly/us/ca/san-diego “Winds NNW at 10 to 15 mph.”<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>https://www.10news.com/weather “Weather Alerts · , Enter zip code to change location · AK · AL · AR · AZ · CA · CO · CT · DC · DE · FL · GA · HI · IA · ID · IL · IN · KS · KY · LA · …”<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>https://www.wunderground.com/hourly/us/ca/san-diego “Tonight 02/22 · 14 % / 0 in · Mostly clear. Low 48F. Winds light and variable.”<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>https://www.weather.gov/sgx “High temperatures continue to increase throughout the week, reaching up to 10 to 20 degrees above average by Friday. Highs reach into the mid-70s at t…”<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>France Facts “The capital of France is Paris.”<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>France Facts “It has a population of about 2.2 million.”<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/claudette\.answer\.ai\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/AnswerDotAI/claudette/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>